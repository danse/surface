<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.5: http://docutils.sourceforge.net/" />
<title>Developer guide</title>
<style type="text/css">


/* Stile sheet tested on Firefox */

/*
  <link rel="stylesheet" type="text/css" href="guide_style.css"/>
 */

body{padding: 0% 2%}

/* Center images and tables */
img{
    display: block;
    margin: 0 auto;
}

table{
    margin-left: auto;
    margin-right: auto;
}

h1{margin-left:0%}
h2{margin-left:10%}
h3{margin-left:20%}
h4{margin-left:30%}

a{
    text-decoration: none;
    color:navy
}

a.footnote-reference{
    font-size: 70%;
    vertical-align: top;
}

div.hint{
    background: azure;
    border: 3px solid silver;
    padding: 20px;
}

p.admonition-title{
    display: none;
}
</style>
</head>
<body>
<div class="document" id="developer-guide">
<h1 class="title">Developer guide</h1>

<!-- comment: $Id: developer_guide.rst 128 2010-12-01 16:12:04Z s242720-studenti $ -->
<!-- comment: the order for section decorations is : _ . ' ` -->
<div class="hint">
<p class="first admonition-title">Hint</p>
<p>Welcome to the developer guide for the SVG whiteboard. The
table of contents may seem huge, but many sections are really
short. You can always click on section titles to come back to the
contents table.</p>
<p>A short description of the contents and why to read them:</p>
<ul class="last simple">
<li>Code structure: read this to understand the general structure
behind the current code and get a first orientation</li>
<li>Data structure: refer to this section (especially the <a class="reference internal" href="#whiteboard-database">Whiteboard
database</a> section) to understand the structure of variables that
are accessed and modified. This section is useful as a reference
even after you are confident with the code structure.</li>
<li>Specific solutions: a place for reminders for taken project
choiches and technology findings</li>
</ul>
</div>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#main-principle" id="id9">Main principle</a><ul>
<li><a class="reference internal" href="#elements-involved" id="id10">Elements involved</a></li>
<li><a class="reference internal" href="#server-mode-parameter" id="id11">Server <tt class="docutils literal"><span class="pre">mode</span></tt> parameter</a></li>
<li><a class="reference internal" href="#principal-division-of-the-application" id="id12">Principal division of the application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#code-structure" id="id13">Code structure</a><ul>
<li><a class="reference internal" href="#client-side" id="id14">Client side</a><ul>
<li><a class="reference internal" href="#dispatching-the-execution-flow-through-the-files" id="id15">Dispatching the execution flow through the files</a></li>
<li><a class="reference internal" href="#object-implementation-on-the-client-side" id="id16">Object implementation on the client side</a></li>
<li><a class="reference internal" href="#the-channel-class" id="id17">The channel class</a></li>
<li><a class="reference internal" href="#the-shape-class" id="id18">The shape class</a></li>
<li><a class="reference internal" href="#client-side-concurrency" id="id19">Client side concurrency</a></li>
</ul>
</li>
<li><a class="reference internal" href="#server-side" id="id20">Server side</a><ul>
<li><a class="reference internal" href="#the-main-switch" id="id21">The main switch</a></li>
<li><a class="reference internal" href="#function-groups-and-server-side-files" id="id22">Function groups and server side files</a></li>
<li><a class="reference internal" href="#steps-for-the-server-response" id="id23">Steps for the server response</a></li>
<li><a class="reference internal" href="#the-client-identifier" id="id24">The client identifier</a></li>
<li><a class="reference internal" href="#export-mode-and-draw-image" id="id25">Export mode and draw_image</a></li>
<li><a class="reference internal" href="#server-side-concurrency" id="id26">Server side concurrency</a></li>
</ul>
</li>
<li><a class="reference internal" href="#emulating-a-client-push-behavior-with-the-http-technology" id="id27">Emulating a client <em>push</em> behavior with the http technology</a></li>
<li><a class="reference internal" href="#global-variables-directly-sent-from-the-server-to-the-client" id="id28">Global variables directly sent from the server to the client</a><ul>
<li><a class="reference internal" href="#role-of-build-user-vars" id="id29">Role of <tt class="docutils literal"><span class="pre">build_user_vars</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#global-and-local-measure-units" id="id30">Global and local measure units</a></li>
<li><a class="reference internal" href="#security-measures" id="id31">Security measures</a><ul>
<li><a class="reference internal" href="#request-signature" id="id32">Request signature</a></li>
<li><a class="reference internal" href="#reply-attack" id="id33">Reply attack</a></li>
</ul>
</li>
<li><a class="reference internal" href="#timeout-effects" id="id34">Timeout effects</a><ul>
<li><a class="reference internal" href="#sender-requests-and-the-send-id" id="id35">Sender requests and the <tt class="docutils literal"><span class="pre">send_id</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#parametric-layout" id="id36">Parametric layout</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-structures" id="id37">Data structures</a><ul>
<li><a class="reference internal" href="#stored-data" id="id38">Stored data</a><ul>
<li><a class="reference internal" href="#whiteboard-database" id="id39">Whiteboard database</a></li>
<li><a class="reference internal" href="#permission-file" id="id40">Permission file</a></li>
<li><a class="reference internal" href="#password-file" id="id41">Password file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#joined-arrays" id="id42">Joined arrays</a><ul>
<li><a class="reference internal" href="#object-id" id="id43">Object id</a></li>
<li><a class="reference internal" href="#action-parameters" id="id44">Action parameters</a></li>
<li><a class="reference internal" href="#drawbacks-and-alternatives-to-the-use-of-joined-arrays" id="id45">Drawbacks and alternatives to the use of joined arrays</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#specific-solutions-and-workarounds" id="id46">Specific solutions and workarounds</a><ul>
<li><a class="reference internal" href="#use-of-svgweb" id="id47">Use of svgweb</a><ul>
<li><a class="reference internal" href="#generic-notes" id="id48">Generic notes</a></li>
<li><a class="reference internal" href="#image-and-anchor-support" id="id49">Image and anchor support</a></li>
<li><a class="reference internal" href="#resize-the-svg-root-node" id="id50">Resize the SVG root node</a></li>
</ul>
</li>
<li><a class="reference internal" href="#coordinates-within-the-svg-canvas" id="id51">Coordinates within the svg canvas</a><ul>
<li><a class="reference internal" href="#browser-behavior-for-svg-offset" id="id52">Browser behavior for svg offset</a></li>
<li><a class="reference internal" href="#browser-behavior-for-scroll-state" id="id53">Browser behavior for scroll state</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#testing-environment-and-methods" id="id54">Testing environment and methods</a><ul>
<li><a class="reference internal" href="#browsers" id="id55">Browsers</a></li>
<li><a class="reference internal" href="#debugging-javascript-in-explorer" id="id56">Debugging Javascript in Explorer</a></li>
<li><a class="reference internal" href="#hardware" id="id57">Hardware</a><ul>
<li><a class="reference internal" href="#performance-problems" id="id58">Performance problems</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#directions-for-further-development" id="id59">Directions for further development</a><ul>
<li><a class="reference internal" href="#prepare-for-html5" id="id60">Prepare for HTML5</a><ul>
<li><a class="reference internal" href="#the-canvas-element" id="id61">The canvas element</a></li>
</ul>
</li>
<li><a class="reference internal" href="#administration-panel" id="id62">Administration panel</a></li>
<li><a class="reference internal" href="#execution-of-the-whiteboard-as-a-cgi" id="id63">Execution of the whiteboard as a CGI</a></li>
</ul>
</li>
<li><a class="reference internal" href="#web-resources" id="id64">Web resources</a></li>
<li><a class="reference internal" href="#notes" id="id65">Notes</a></li>
</ul>
</div>
<div class="section" id="main-principle">
<h1><a class="toc-backref" href="#id9">Main principle</a></h1>
<p>The leading idea behind the application is a lightweight interaction
model which, combined with the capabilities of vector graphics, allows
to support a shared whiteboard through the exchange of few textual
messages.</p>
<p>The textual representation of vector graphics is common knowledge, and
is easy to understand how this can enable to transmit graphic data
with short communication messages (although in some cases this
advantage may fail). I will focus now on the overall sharing model,
thought to provide each client with an updated state of the
whiteboard.</p>
<p>The fundamental event that triggers the evolution of the application,
is an user <strong>action</strong>, that is a change on the user whiteboard that is
supposed to be propagated to all other clients. To mantain an updated
state, the actions get propagated one by one when executed, even if
some of them could nullify the effect of some others (like for a
deletion of a created object).</p>
<p>Each <strong>action</strong> is represented by a textual <strong>update</strong> which contains
all relevant informations about what the user did. The main purpose of
the server side of the application is to manage the distribution of
these updates.</p>
<p>The web technology prevents the client side code to directly
communicate with other clients, so an extern server is
compulsory. Moreover, the same technology prevents the clients to
directly receive updates in a <em>push</em> manner (websockets in html5 are
going to provide push methods to client in the future), so a server is
needed to provide updates in response of <em>pull</em> requests (see
<a class="reference internal" href="#emulating-a-client-push-behavior-with-the-http-technology">Emulating a client push behavior with the http technology</a> for
performance details).</p>
<p>So the server role is to manage an <strong>update database</strong> so that each
client can ask for new updates, depending on his own state. With the
access to a writable storage device, that is very common even on the
smallest web servers, the server can manage a bigger update database,
and mantain all the state of a whiteboard, since its creation, in this
action-oriented form.</p>
<p>The following image illustrates a simple case of update
management. Here you can immediately see some important elements that
constitute the application's internals:</p>
<ul class="simple">
<li>The <strong>update database</strong>, that is the main data structure on the
server</li>
<li>The two principal requests made from the clients to the server, that
are the <strong>read</strong> and the <strong>write</strong> requests</li>
</ul>
<img alt="images/base_principle.png" src="images/base_principle.png" />
<p>The update is sent, usually, when the user terminates an operation, be
that a move, create or edit action. Then the update is sent to the
server (this is a request with the <tt class="docutils literal"><span class="pre">mode</span></tt> parameter set to
<tt class="docutils literal"><span class="pre">write</span></tt>), which gives it a numerical incremental identificator and
adds it to the database. At the same time, several clients are asking
for updates sending a request with <tt class="docutils literal"><span class="pre">mode</span></tt> set to <tt class="docutils literal"><span class="pre">read</span></tt>, including
the identificator of the next update which they are interested in.</p>
<div class="section" id="elements-involved">
<h2><a class="toc-backref" href="#id10">Elements involved</a></h2>
<p>In this case, the main parts of the software which are running are:</p>
<ul class="simple">
<li>for the addition of a new update, the global <strong>sender</strong> object
(<tt class="docutils literal"><span class="pre">g['sender']</span></tt>) on the client side and the <tt class="docutils literal"><span class="pre">write</span></tt> <strong>mode</strong> on the
server side</li>
<li>for the request about new updates, the global <strong>receiver</strong> object
(<tt class="docutils literal"><span class="pre">g['receiver']</span></tt>) on the client side and the <tt class="docutils literal"><span class="pre">read</span></tt> <strong>mode</strong> on the
server side</li>
</ul>
</div>
<div class="section" id="server-mode-parameter">
<h2><a class="toc-backref" href="#id11">Server <tt class="docutils literal"><span class="pre">mode</span></tt> parameter</a></h2>
<p>I mentioned above the server's <tt class="docutils literal"><span class="pre">mode</span></tt> parameter, this is the main
query field determining the kind of the server's response.</p>
<p>The server side code is structured following a functional programming
paradigm, on the purpose of making the execution flow as clear as
possible. We have the two certain boundaries of this flow, that are
the start by a user request, and the end by a response to the user, so
the different server behaviors are conceived like parallel ways on the
same path, in a few words they are the branches of a big <tt class="docutils literal"><span class="pre">switch</span></tt>
control structure, and the <tt class="docutils literal"><span class="pre">mode</span></tt> parameter is the one that
determines which way will be taken. Take a look at the <tt class="docutils literal"><span class="pre">main.php</span></tt>
file to easily verify what explained.</p>
</div>
<div class="section" id="principal-division-of-the-application">
<h2><a class="toc-backref" href="#id12">Principal division of the application</a></h2>
<p>The main elements constituting the application's structure are:</p>
<ul class="simple">
<li>Client side code (<tt class="docutils literal"><span class="pre">client/</span></tt> directory)</li>
<li>Server side code (<tt class="docutils literal"><span class="pre">server/</span></tt> directory)</li>
<li>Stored data (<tt class="docutils literal"><span class="pre">data/</span></tt> directory)</li>
</ul>
<p>All of them reside on the webserver, in a form optimized by the
makefile, but their original structure is intended to help a developer
to move through the code and clearly understand what is being done.  I
will write here about the server side and client side code, while for
the form of the stored data see the section <a class="reference internal" href="#stored-data">Stored data</a> under <a class="reference internal" href="#data-structures">Data
structures</a>.</p>
<p>The client and server side of the source code are documented into the
following section, <a class="reference internal" href="#code-structure">Code structure</a>, while the data are documented
into <a class="reference internal" href="#data-structures">Data structures</a>, together with the meaning of complex
variables used into the code.</p>
</div>
</div>
<div class="section" id="code-structure">
<h1><a class="toc-backref" href="#id13">Code structure</a></h1>
<p>In this section I will present the main structures thought to organize
the code. The order of the subsections reflects the importance of each
topic. The first two subsections deal with those structures limited to
the client or the server side, while the following sections present
topics which involve both sides of the application.</p>
<div class="section" id="client-side">
<h2><a class="toc-backref" href="#id14">Client side</a></h2>
<p>Following a general rule of network protocols, I've tried to move the
biggest part of the computational load towards the network boundaries,
that means towards clients, leaving it off from the server.</p>
<p>Current hardware performances for an average web browser aren't an
heavy limit for this kind (strongly interactive) of applications, or
at least I couldn't observe any performance problem related to
javascript on the testing machine (and virtual machine), which runs on
quite old hardware (see <a class="reference internal" href="#hardware">Hardware</a>).</p>
<p>The biggest problem I met was therefore that of readability and
decomposition of the client side code.</p>
<p>The starting code was all based on global variables, and I choosed to
proceed by steps, instead of trowing away the existing structure. The
resulting code has an hybrid programming paradigm, being object
oriented just in some of his parts <a class="footnote-reference" href="#client-rewrite" id="id1">[1]</a>.</p>
<p>The javascript code is divided among files in a way that follows the
graphical division of the user interface, as shown in the image below:</p>
<img alt="images/client_surface.png" src="images/client_surface.png" />
<p>The javascript function definitions can be found on the file
corresponding to the zone of the page containing the html element to
which the method is associated. For example, this html code can be
read about the &quot;Import&quot; button, which is contained into the menu:</p>
<pre class="literal-block">
&lt;button onclick=&quot;show_div('menu_import', true)&quot;&gt;Import&lt;/button&gt;
</pre>
<p>Since the &quot;Import&quot; button is contained into the menu, the programmer
will find the <tt class="docutils literal"><span class="pre">show_div</span></tt> function declaration inside menu.js.</p>
<p>Another consequence of the shown division is that there are two
javascript files, <tt class="docutils literal"><span class="pre">login.js</span></tt> and <tt class="docutils literal"><span class="pre">application.js</span></tt>, which are
associated to a whole html page. Thus the initialization functions for
each page are contained into the corresponding file; see the next
section for details about the one contained in <tt class="docutils literal"><span class="pre">whiteboard.js</span></tt>,
which is the more complex.</p>
<p>To be complete, it's better to immediately consider another image
which introduces also those javascript files not directly associated
to a visible surface of the user interface. The image illustrate the
use relationships between the javascript files, a very useful
information while browsing the code:</p>
<img alt="images/client_file_use.png" src="images/client_file_use.png" />
<p>An arrow from a start file to an end file means that the code of the
start file calls some functions which are defined into the end
file. Two new informations come from the structure of the diagram:</p>
<ul class="simple">
<li>the role of <tt class="docutils literal"><span class="pre">common.js</span></tt> that is like a little shared library for
common tasks (the most important thing, it contains the channel
class)</li>
<li>the presence of the <tt class="docutils literal"><span class="pre">shapes.js</span></tt> file (containing the shape class
and all shape objects derived from that), which is used exclusively
by functions into <tt class="docutils literal"><span class="pre">whiteboard.js</span></tt></li>
</ul>
<p>The introduced division of client side code it not totally rigid,
there are still dependencies, here and there, between variables
defined into different files. I've tried to collect into common.js the
variables, functions and objects used by several files, like the
global object <tt class="docutils literal"><span class="pre">g</span></tt> holding all global variables, and the <tt class="docutils literal"><span class="pre">channel</span></tt>
and <tt class="docutils literal"><span class="pre">signer</span></tt> objects.</p>
<div class="section" id="dispatching-the-execution-flow-through-the-files">
<h3><a class="toc-backref" href="#id15">Dispatching the execution flow through the files</a></h3>
<p>On the purpose of decomposing the client logic, also global variables
are defined within the files where they are used. When the client side
state is initialized, several functions are called, each one to
initialize the variables belonging to a file.</p>
<p>The main initialization function is defined into <tt class="docutils literal"><span class="pre">application.js</span></tt>;
it initializes the variables defined into <tt class="docutils literal"><span class="pre">application.js</span></tt> and than
calls the initialization functions for the file <tt class="docutils literal"><span class="pre">whiteboard.js</span></tt> and
<tt class="docutils literal"><span class="pre">menu.js</span></tt>:</p>
<pre class="literal-block">
window.onsvgload = function() {
    ...
    initWhiteboard();
    initMenu();
    ...
};
</pre>
<p>A similar approach is used when an update is received by the
client. The <tt class="docutils literal"><span class="pre">receiver_handler</span></tt> function (into <tt class="docutils literal"><span class="pre">application.js</span></tt>)
calls the specific functions belonging the the files <tt class="docutils literal"><span class="pre">whiteboard.js</span></tt>
and <tt class="docutils literal"><span class="pre">chat.js</span></tt>, since within those files the developer will found all
functions needed to process the update of the right type:</p>
<pre class="literal-block">
function receiver_handler(){
    ...
    if (action == 'chat')
        chatServerUpdate(madeBy, objId, parameters, time);
    else{
        ...
        whiteboardServerUpdate(objId, page, action, parameters);
        }
    ...
}
</pre>
<p>Note that the approach used for the initialization and for the
processing of an update is a total waste of resources, from the
computational point of wiew. It is just an effort to organize the code
for the developer.</p>
</div>
<div class="section" id="object-implementation-on-the-client-side">
<h3><a class="toc-backref" href="#id16">Object implementation on the client side</a></h3>
<p>The javascript language is very flexible when it comes to object or
class definition, due to his prototypal model and the possibility of
dynamically add member functions and internal variables to the
objects. Although an uniform programming style is important for
readability and to avoid mistakes, the few javascript objects are
defined in different ways, depending on their lifecycle.</p>
<p>All the objects that will be created dynamically (<tt class="docutils literal"><span class="pre">line</span></tt>, <tt class="docutils literal"><span class="pre">circle</span></tt>
and all the shapes, and the <tt class="docutils literal"><span class="pre">shape</span></tt> and <tt class="docutils literal"><span class="pre">channel</span></tt> classes) are
defined through their constructors, while permanent singleton objects
(<tt class="docutils literal"><span class="pre">g['signer']</span></tt>, <tt class="docutils literal"><span class="pre">g['sender']</span></tt>, <tt class="docutils literal"><span class="pre">g['receiver']</span></tt>, <tt class="docutils literal"><span class="pre">g['pages']</span></tt>
and <tt class="docutils literal"><span class="pre">g['size_adapter']</span></tt>) are directly built and assigned to the
global variable where they will remain.</p>
</div>
<div class="section" id="the-channel-class">
<h3><a class="toc-backref" href="#id17">The channel class</a></h3>
<p>The channel class provides an ajax channel to the server, with some
functions to send the request, handle errors, and retry the request
after a timeout. A channel object is contained (and used) by all other
objects which need to exchange data with the server in an asynchronous
manner.</p>
<img alt="images/Channel_use_diagram.png" src="images/Channel_use_diagram.png" />
<p>The responsabilities of the channel class are:</p>
<blockquote>
<ul class="simple">
<li>Create, send and receive an ajax request in a way which is
supported cross-browser</li>
<li>Handle the case of timeout of the sent request, sending again the
same request</li>
</ul>
</blockquote>
<p>These functions are used by the <tt class="docutils literal"><span class="pre">login</span></tt> and <tt class="docutils literal"><span class="pre">sender</span></tt> objects to
send individual messages, and by the <tt class="docutils literal"><span class="pre">receiver</span></tt> and <tt class="docutils literal"><span class="pre">signer</span></tt>
objects to send messages in a cycle.</p>
<p>The structure of objects using <tt class="docutils literal"><span class="pre">channel</span></tt> is a little messy, because
the channel object needs methods which are exposed on the global
scope, in order to assign them as handlers for timeout and ajax
statechange events. For example, the <tt class="docutils literal"><span class="pre">g['sender']</span></tt> object defines
two global methods that are assigned to the channel object during its
initialization (code taken from <tt class="docutils literal"><span class="pre">application.js</span></tt>):</p>
<pre class="literal-block">
// Sender initialization
g['sender'].channel =
    createChannel(sender_handler, sender_timeout, 10000, send_par);

// Sender object and methods
g['sender'] = {
    ...
};
function sender_timeout(){
    g['sender'].channel.handle_timeout();
}
function sender_handler(){
    ...
}
</pre>
<p>The methods must be defined outside of the object, which is not very
elegant, but it is the only way. Moreover, you can observe that the
<tt class="docutils literal"><span class="pre">sender_timeout</span></tt> method just calls a method into the channel
object. This is even less elegant and this is done by all objects that
use a channel object, because it is difficult in javascript to assign
an inner method of an object as handler for an event like the timeout.</p>
<div class="section" id="client-send-buffer-and-the-sender-object">
<h4>Client send buffer and the <tt class="docutils literal"><span class="pre">sender</span></tt> object</h4>
<p>The channel class is used by two important objects, the <em>sender</em> and
the <em>receiver</em>; both of them are defined into the file
<tt class="docutils literal"><span class="pre">application.js</span></tt>. The channel class itself handles the failure and
resend of ajax requests, but the sender object needs anyway a buffer
to temporarily store the updates produced by the user.</p>
<p>The function that adds a new update to the buffer (server_add) has the
following interface:</p>
<pre class="literal-block">
sender_add(action, parameters, varidObj, async)
</pre>
<p>All parameters but <tt class="docutils literal"><span class="pre">action</span></tt> are optional, and the last (<tt class="docutils literal"><span class="pre">asinc</span></tt>)
is useful to add a new update line into the database without trying to
flush it. Indeed, <tt class="docutils literal"><span class="pre">sender_add</span></tt> usually tries to flush the buffer
right after it's execution, but when the user edits a shape, for
example, it is better if the old shape's deletion and the new shape's
creation are sent to the server at the same time.</p>
<p>The sender channel (like all other objects that use the <tt class="docutils literal"><span class="pre">channel</span></tt>
class) waits that an old ajax request has succeeded before sending a
new one. When the <tt class="docutils literal"><span class="pre">sender</span></tt> object receives a response from the
server, it checks its buffer for updates collected in the meantime
since the request was sent.</p>
<p>Here it is the relative code (into application.js). The response
handler (sender_handler) can call again the send function (line 7):</p>
<pre class="literal-block">
1  function sender_handler(){
2      var response = g['sender'].channel.received();
3      if(response !== false){
4          // If still have data to send (added while waiting the server
5          // response)
6          if (g['sender'].line_buff.length &gt; 0)
7              sender_send();
8      }
9  }
</pre>
<p>For all objects which use the <tt class="docutils literal"><span class="pre">channel</span></tt> class, the handling of a
failure (a <tt class="docutils literal"><span class="pre">false</span></tt> response received by the channel class) is a
delicate matter. A <tt class="docutils literal"><span class="pre">false</span></tt> response is returned every time that, for
example, the readyState of the response is not the right one, so the
handler receiving from <tt class="docutils literal"><span class="pre">channel</span></tt> should simply ignore the call and
do nothing. This interface, however, is likely to be changed because
explicit errors (see next section) are better handled by the specific
handler receiving from channel.</p>
</div>
<div class="section" id="handling-of-ajax-errors">
<h4>Handling of AJAX errors</h4>
<p>The <tt class="docutils literal"><span class="pre">channel.received</span></tt> method is called by <tt class="docutils literal"><span class="pre">channel</span></tt> users each
time that the XMLHttpResponse object changes its state, and the
<tt class="docutils literal"><span class="pre">ready</span></tt> state is only the forth, so many times the method simply
returns the <tt class="docutils literal"><span class="pre">false</span></tt> value to tell to its caller that the moment
isn't already arrived.</p>
<p>Besides receiving a correct ready response, several kind of errors can
occurr while the <em>channel</em> class is awaiting. First I will present the
different kind of errors, and then I will tell how they are handled.</p>
<ul>
<li><p class="first"><strong>malformed XML</strong> This can cover a variety of errors: during the development these are
usually php errors which output the details of the error instead of
the XML response. Sometimes, with explorer (6), these errors can be due
to a malformed ajax request, which occurs randomly and which is not
repeated by the browser if the request is resent.</p>
<p>A problem in the handling of this errors is that there isn't a
method to verify the valid XML structure of the response (into the
class XMLDocument), so an exception could be risen when upstream
code tries to parse the received response. Thus to try to locate XML
errors, I try to access to the last nodes or to the whole first
level of child node, but this method is not sure, it depends from
the parser implementation:</p>
<pre class="literal-block">
try{
    var response = this.request.responseXML.documentElement;
    // These are used to force explorer (and other
    // browsers) to parse the XML document to spot errors
    response.lastChild;
    response.childNodes;
}
catch(e){
    // *malformed response*: this could even be a php
    // error. Firefox raises an exception on
    // this.request.responseXML while Explorer should raise an
    // exception on response.lastChild
    var msg = 'A server error occurred:\n\n'+this.request.responseText;
}
</pre>
</li>
<li><p class="first"><strong>Http errors</strong> They are signaled to the client side code with a request whose state
is 'ready' but whose 'status' is different from 200. This includes
the case of an unreachable server (http status '0').</p>
</li>
<li><p class="first"><strong>Timeouts</strong> When the response doesn't comes within the timeout.</p>
</li>
<li><p class="first"><strong>Explicit errors</strong> These are errors sent on purpose by the server
to the client, in order to show an error message client-side or to
impose a behavior (for example: logout). This is told to the client
through an <tt class="docutils literal"><span class="pre">error</span></tt> XML tag.</p>
</li>
</ul>
<p>About the handling of these errors, the first distinction is about the
<strong>explicit errors</strong>: they are different within different channels, so
they are handled outside of the channel. Other kind of errors may
occur with all channels and are handled within the
<tt class="docutils literal"><span class="pre">channel.received</span></tt> method.</p>
<p>A <strong>malformed XML</strong> response or an <strong>http error</strong> are handled the same
way: a message is prompted to the user, trying to be as clear as
possible, and he can decide if to repeat the request or to give up (in
this case he will be logged out from the whiteboard). This behavior
works well with the case of a server complaining for a malformed ajax
request, which occurs randomly with explorer (this triggers a
malformed XML error). This works well also when an http error is given
due to a server not responding (the user may notice, for example, that
his network is down and retry).</p>
<p>A <strong>timeout</strong> error simply triggers a new send with the same
parameters, and the user is warned with a subtle notification but he
doesn't has to decide anything.</p>
</div>
<div class="section" id="the-deletion-of-a-whiteboard-on-the-client-side">
<h4>The deletion of a whiteboard on the client side</h4>
<p>The deletion of a whiteboard while several users are working on it is
an event which can lead to the failure of several server side
operations. Simultaneusly, several ajax requests made from the client
side may fail, and I decided to not take care of each one of these
failures, but to rely on the failure of the whiteboard's heartbeat:
the 'receive cycle'.</p>
<p>The whiteboard is almost <a class="footnote-reference" href="#almost" id="id2">[6]</a> always awaiting for a response from
the server, because of the <tt class="docutils literal"><span class="pre">g['receiver']</span></tt> object and the receive
cycle it manages, so I demanded to this object the handling of the
<tt class="docutils literal"><span class="pre">whiteboard</span> <span class="pre">deleted</span></tt> <strong>explicit error</strong> (see section above), which
leads to the logout of the user from the whiteboard. Other client-side
failures due to a deleted whiteboard are simply ignored, relying on a
prompt reaction of the receiver object.</p>
</div>
</div>
<div class="section" id="the-shape-class">
<h3><a class="toc-backref" href="#id18">The shape class</a></h3>
<p>The <strong>shape</strong> class came from the attempt to simplify the code running
into the whiteboard. This class is used only through its derived
classes (it can be seen as an abstract class) and by the functions
into the file <tt class="docutils literal"><span class="pre">whiteboard.js</span></tt>.</p>
<img alt="images/Shape_derivation_diagram.png" src="images/Shape_derivation_diagram.png" />
<p>This diagram shows only the public methods, for the protected ones see
the next figure. The shape class has mainly three virtual methods
(mousedown, mousemove, mouseup), which must be overridden by the
derived shapes, even if the language syntax doesn't provides any
keywork to indicate virtual methods.</p>
<p>The idea behind this class is that when an user chooses a tool that
corresponds to a shape, all mouse (and keyboard) actions inside the
canvas get forwarded to the corresponding shape class, and the class
decides how to handle the mousedown, mousemove, and mouseup
events. This structure aims to achieve both modularity and flexibility
in the definition of classes.</p>
<p>There are two kind of shapes derived from <tt class="docutils literal"><span class="pre">shape</span></tt>:</p>
<ul class="simple">
<li><strong>dynamic shapes</strong>: they are the most part. In this case a shape
corresponds tightly with an SVG element, and many methods can
automatically copy attribute values from the shape to the server or
to the SVG element. The aspect of these shapes changes while the
user is creating them, but they are created all together on the
canvas of the other users receiving the update.</li>
<li><strong>static shapes</strong>: these are the <strong>text</strong>, <strong>link</strong>, and <strong>image</strong>
shapes. They are created within a single function, because the
intermediate state is constituted by a text that the user changes
into the textarea. For these shapes, the correspondence with an SVG
element is less tight, because their actual structure on the svg
canvas is more complex; this is the reason why all static shapes
override the <tt class="docutils literal"><span class="pre">server_create</span></tt> method.</li>
</ul>
<p>This distinction doesn't corresponds with any structure into the code,
but it helps to understand the different use of <tt class="docutils literal"><span class="pre">shape</span></tt> protected
methods on part of his derived shapes. These protected methods are the
part of the base class which can be used by several shapes with a
similar behavior.</p>
<p><tt class="docutils literal"><span class="pre">shape</span></tt> protected methods are defined on two levels, a first level
of methods which is used by the second level. Usually, derived shapes
use the second level, but sometimes they can need customization and
rise up to the first level (this is the case of the <em>path</em> shape,
which needs to build custom groups to handle the creation of
multipaths). This simple diagram shortly describes the relationships
between the protected methods into the shape class:</p>
<img alt="images/shape_protected_methods.png" src="images/shape_protected_methods.png" />
<p>The methods on the first column can be thought as a first level, and
the ones on the second column as a second level. These are not all
protected methods (some are public), but they are all methods which
are reused inside the derived shapes.</p>
<p>The meaning of the words into the ellipses is:</p>
<ul class="simple">
<li>shape: the shape object (has attributes as object properties)</li>
<li>element: the SVG element (his attributes correspond to visual properties)</li>
<li>server: the server update (attributes are encoded as an ordered array)</li>
</ul>
<p>This skecth can be useful to get an idea of the overall structure, but
many details are missing which can be found in the code.</p>
<div class="section" id="random-remarks-on-the-structure-of-the-shape-class">
<h4>Random remarks on the structure of the shape class</h4>
<p>The methods <tt class="docutils literal"><span class="pre">open_shape()</span></tt> and <tt class="docutils literal"><span class="pre">close_shape()</span></tt> handle the <tt class="docutils literal"><span class="pre">open</span></tt>
flag; this is read upstream to know if the shape is open (an user
can't change his tool if he has an unclosed shape).</p>
<p>The method <tt class="docutils literal"><span class="pre">copy_shape</span></tt> sets also the <tt class="docutils literal"><span class="pre">edit</span></tt> flag true. All
derived shapes can change their behavior when the shape is in edit
mode.</p>
<p>Usually a shape remains alive during all the time while the
corresponding tool is selected, continuously generating new elements
and server updates. On the other hand, with the edit tool a shape is
copied by an existing one, and it shouldn't generate new shapes after
that the editing is finished. For this reason, when an edited shape is
closed, its <tt class="docutils literal"><span class="pre">active</span></tt> flag is set to false, so that the upstream code
can understand that no more shapes of that type should be created
(<tt class="docutils literal"><span class="pre">close_shape</span></tt> method).</p>
</div>
</div>
<div class="section" id="client-side-concurrency">
<h3><a class="toc-backref" href="#id19">Client side concurrency</a></h3>
<p>Even if I couldn't find a clear specification of the behavior of the
javascript language with respect to concurrency, from several articles
found on the web and from the practice it results that javascript
doesn't supports preemption, thus an event is handled after that the
current block has ended.</p>
<p>To avoid concurrency problems, is thus necessary to mantain the
coherence of global variables within each function that changes
them. This is easier for the new parts of the code which are
structured following the object oriented paradigm.</p>
<p>Sometimes (<tt class="docutils literal"><span class="pre">sender_handler</span></tt> function inside <tt class="docutils literal"><span class="pre">application.js</span></tt>,
<tt class="docutils literal"><span class="pre">login_handler</span></tt> function inside <tt class="docutils literal"><span class="pre">login.js</span></tt>) when receiving an ajax
response from the server, the underlying datas are checked, to be sure
that the response is still valid or to know if a new request should be
sent.</p>
</div>
</div>
<div class="section" id="server-side">
<h2><a class="toc-backref" href="#id20">Server side</a></h2>
<p>The server side is decomposed following a procedural paradigm, which I
think is better to describe the control flow in this case. However, to
reduce the complexity of function interfaces, some of their parameters
have been packed into an associative array (see <a class="reference internal" href="#the-client-identifier">The client identifier</a>).</p>
<p>The choice of a procedural decomposition came from the consideration
that the server code doesn't actually follows complex control flows,
but instead the whole logic is started with each user request and ends
with a response to that user, changing eventually the database as an
important side effect.</p>
<div class="section" id="the-main-switch">
<h3><a class="toc-backref" href="#id21">The main switch</a></h3>
<p>The execution flow is described in its principal steps into the
<tt class="docutils literal"><span class="pre">main()</span></tt> function, where I tried to balance the readability (that
means hiding the code by incapsulation) with the expression of the
underlying logic.</p>
<p>To achieve this goal, there is a separation of functions into groups,
and the structures into <tt class="docutils literal"><span class="pre">main()</span></tt> do the association between the user
request and the corresponding functions.</p>
</div>
<div class="section" id="function-groups-and-server-side-files">
<h3><a class="toc-backref" href="#id22">Function groups and server side files</a></h3>
<p>The function used by <tt class="docutils literal"><span class="pre">main()</span></tt> are mainly grouped into two types:</p>
<blockquote>
<ul class="simple">
<li>modifying the database (file <tt class="docutils literal"><span class="pre">updates.php</span></tt>): The functions that
modify the database are all defined into <tt class="docutils literal"><span class="pre">udpates.php</span></tt>, so that
the database structure is somehow encapsulated into this file. The
file contains the functions called by <tt class="docutils literal"><span class="pre">main()</span></tt>, but it contains
also functions called just internally, and defined to reuse the
code or to improve the readability</li>
<li>formatting the output (file <tt class="docutils literal"><span class="pre">markup_send.php</span></tt>): Here, all the
functions that write HTML or XML are defined, to wrap the data
received upstream by <tt class="docutils literal"><span class="pre">main()</span></tt>, and to send them to the user.</li>
</ul>
</blockquote>
<p>Sometimes, this division turns into an excessive rigidity, and
sometimes (in the case of <tt class="docutils literal"><span class="pre">export_chat</span></tt>) a function into updates.php
also cares for formatting, but this remains a guideline into the
structure of the server side code.</p>
<p>With the grouping of functions into the files and the procedural
decomposition model I used, it is easy to follow the execution flow
through the various files that compose the server side code. The
following diagram shows the use relations between server side files
(the <tt class="docutils literal"><span class="pre">.php</span></tt> extension is omitted) when an user sends a request. An
arrow starting from a file and arriving into another file means that
the first file is using a function from the second one.</p>
<img alt="images/server_file_use_simplified.png" src="images/server_file_use_simplified.png" />
<p>As can be seen, from the <tt class="docutils literal"><span class="pre">main</span></tt> file the execution flow goes to the
<tt class="docutils literal"><span class="pre">update</span></tt> functions, which in turn call the functions from
<tt class="docutils literal"><span class="pre">file_access</span></tt> to read and write the update database copy on the
disk. When the <tt class="docutils literal"><span class="pre">update</span></tt> functions give back the control flow to the
<tt class="docutils literal"><span class="pre">main</span></tt> file, it uses the returned values to call the functions into
<tt class="docutils literal"><span class="pre">markup_send</span></tt>, to send back the response to the user.</p>
</div>
<div class="section" id="steps-for-the-server-response">
<h3><a class="toc-backref" href="#id23">Steps for the server response</a></h3>
<p>The presented function groups correspond also with two steps of the
server operation, and so they can be found used into two successive
switches inside <tt class="docutils literal"><span class="pre">main()</span></tt>: a firs one based on the <tt class="docutils literal"><span class="pre">mode</span></tt> parameter
that chooses among which <em>update</em> function to use, and a second one
based on the <tt class="docutils literal"><span class="pre">$o['type']</span></tt> (output type) parameter that chooses among
which <em>markup send</em> function to use <a class="footnote-reference" href="#database-double-access" id="id3">[2]</a>.</p>
<p>The <em>markup send</em> step is born to collect formatting functions that
were common between several <em>modes</em>, so the output functions for the
<tt class="docutils literal"><span class="pre">export</span></tt> mode remain outside from this step: they stay into the
<tt class="docutils literal"><span class="pre">export</span></tt> branch of the <em>update</em> switch, since they are used just
there. The <tt class="docutils literal"><span class="pre">export</span></tt> mode is quite different from the others, and the
<a class="reference internal" href="#export-mode-and-draw-image">Export mode and draw_image</a> section covers its characteristics.</p>
</div>
<div class="section" id="the-client-identifier">
<h3><a class="toc-backref" href="#id24">The client identifier</a></h3>
<p>The drawback of a procedural decomposition paradigm is that many
functions belonging to the same processing step could require the same
data set, resulting in big and redundant function interfaces. For
example, the functions belonging to the <em>update</em> step often need
informations about the user which sent the request, his user id (to
improve performances reducing database search), and the name of the
whiteboard where he is operating.</p>
<p>I packed all these variables into the variable <tt class="docutils literal"><span class="pre">$client_id</span></tt>, which
is a parameter of all the functions of the <em>update</em> step. The variable
is sent by the client or produced by the <tt class="docutils literal"><span class="pre">login</span></tt> function in the
form of a joined array with the structure:</p>
<pre class="literal-block">
&lt;user id&gt; . '_' . &lt;user name&gt; . '_' . &lt;whiteboard name&gt;
</pre>
<p>And it is parsed by <tt class="docutils literal"><span class="pre">parse_client_id</span></tt> into an associative array, to
provide textual keys to the functions. This array can be found as a
parameter of almost all <em>update</em> functions.</p>
</div>
<div class="section" id="export-mode-and-draw-image">
<h3><a class="toc-backref" href="#id25">Export mode and draw_image</a></h3>
<p>This mode deserves a specific coverage, because is more complex than
all the other methods and requires a whole file (<tt class="docutils literal"><span class="pre">draw_image.php</span></tt>)
just to accomplish the operations required to export the whiteboard
contents.</p>
<p>The complexity arises from two factors:</p>
<dl class="docutils">
<dt>Database structure</dt>
<dd>The server doesn't actually sees the current state of the
whiteboard, but it simply keeps the received updates. Thus, only
for this mode, it must walk through the whole database and
transform the update list into a structure reflecting the status
(the <tt class="docutils literal"><span class="pre">$objects</span></tt> variable). This task has been incapsulated into
the <tt class="docutils literal"><span class="pre">export_whiteboard</span></tt> function (<tt class="docutils literal"><span class="pre">updates.php</span></tt>).</dd>
<dt>Format encoding</dt>
<dd>A change from one format to another, which is simple a matter of
changing a form value for the user, entails whole sets of
different operations into the server side code, since the functions
may change for each object type. This task has been incapsulated
into the <tt class="docutils literal"><span class="pre">draw_image</span></tt> function (<tt class="docutils literal"><span class="pre">draw_image.php</span></tt>).</dd>
</dl>
<p>The <tt class="docutils literal"><span class="pre">export_whiteboard</span></tt> function does also all operations which will
be useful for every kind of export format, for example it parses
complex action parameters and it translates the sizes from global
units to local units (see <a class="reference internal" href="#global-and-local-measure-units">Global and local measure units</a>); this
makes the two tasks (the production of the <tt class="docutils literal"><span class="pre">$objects</span></tt> variable and
its output as a file for the user) tightly coupled but the division
between them seems reasonable to me to organize the code.</p>
<p>All the code for the export mode is strongly dependent by the position
of the parameters into each update string. This is a problem for
readability and maintainability, that I discuss into <a class="reference internal" href="#joined-arrays-for-the-action-parameters">Joined arrays for
the action parameters</a>, where I introduce some ideas to change the
current structure.</p>
<p>Now that this mode has been presented, I can show the full use diagram
between server side files, including even those files which are
secondary and related to this specific mode:</p>
<img alt="images/server_file_use_full.png" src="images/server_file_use_full.png" />
</div>
<div class="section" id="server-side-concurrency">
<h3><a class="toc-backref" href="#id26">Server side concurrency</a></h3>
<p>On the server side, concurrency problems arise for the access to the
shared files on the disk (see <a class="reference internal" href="#stored-data">stored data</a> for an overview of such
files). As seen into the section <a class="reference internal" href="#function-groups-and-server-side-files">Function groups and server side
files</a>, all the functions that read and write disk files are grouped
together into the file <tt class="docutils literal"><span class="pre">file_access.php</span></tt>, so these are the functions
which also handle the problem of concurrency <a class="footnote-reference" href="#concurrency" id="id4">[3]</a>. All
these functions are called just by other functions defined in
<tt class="docutils literal"><span class="pre">updates.php</span></tt>, with the exception of <tt class="docutils literal"><span class="pre">check_files()</span></tt>.</p>
<p>First of all, some of the files do not present concurrency problems:
the <em>permissions</em> file is read-only (writable only by hand by the
administrator) and the <em>log</em> file is write-only.</p>
<p>The changing and shared files are:</p>
<blockquote>
<ul class="simple">
<li>the <strong>passwords</strong> file</li>
<li>the <strong>whiteboard</strong> database for each whiteboard</li>
<li>the image folder for each whiteboard</li>
</ul>
</blockquote>
<p>The passwords file and the whiteboard databases may change
their content, while both the whiteboard databases and the image
folders may exist or not exist at all.</p>
<div class="section" id="encoded-files">
<h4>Encoded files</h4>
<p>The <strong>passwords</strong> file and the <strong>whiteboard</strong> database files have the
common property of being an encoded form of a php array. The functions
accessing to these files (whiteboard_create, whiteboard_delete,
file_create, <strong>file_get</strong> and <strong>file_put</strong>) handle both the variable
encoding/decoding and the concurrent access.</p>
</div>
<div class="section" id="use-of-file-get-and-put">
<h4>Use of file get and put</h4>
<p>Both the definition and the use of <tt class="docutils literal"><span class="pre">file_get</span></tt> and <tt class="docutils literal"><span class="pre">file_put</span></tt> are
straightforward <a class="footnote-reference" href="#fread-problems" id="id5">[4]</a>. Into the file <tt class="docutils literal"><span class="pre">updates.php</span></tt>, all
actions executed between a <em>write file_get</em> and a file_put can be
thought as acting on an exclusive locked version of the database. I
wrote <em>write file_get</em> because this function can be called with a read
(<tt class="docutils literal"><span class="pre">r</span></tt>) or a read write (<tt class="docutils literal"><span class="pre">rw</span></tt>) value as mode argument; when it is
called with a <tt class="docutils literal"><span class="pre">rw</span></tt> mode, it returns also an handler, which must be
given back to file_put to terminate the critical section.</p>
<pre class="literal-block">
list($h, $d) = file_get($wb_file, 'rw');
...
file_put($h, $d);
</pre>
<p>The second parameter of <tt class="docutils literal"><span class="pre">file_put</span></tt> is useful to tell to the function
that the data have been modified, and so they must be written on the
file. Sometimes, functions into <tt class="docutils literal"><span class="pre">updates.php</span></tt> can open the file with
the <tt class="docutils literal"><span class="pre">'rw'</span></tt> mode but don't actually modify the data, in this case
they can use <tt class="docutils literal"><span class="pre">file_put($h)</span></tt> simply omitting the second parameter.</p>
</div>
<div class="section" id="double-locking-level">
<h4>Double locking level</h4>
<p>Each <strong>whiteboard</strong> database file can be accessed independently, so
the locking should be done singularly over each of those
files. However, since those files can be existent or not, a prior
atomical check must be done on file existence, so the locking of
whiteboard database files has two levels. Since the <strong>passwords</strong> file
is accessed through the same functions, the double lock is used also
for that file, even if this is not strictly necessary.</p>
<p>The files mentioned above are accessed through the following four
functions, which use a global lock file and a local lock file for each
operation:</p>
<ul class="simple">
<li>whiteboard_create, whiteboard_delete, file_create (for passwords file)</li>
<li>file_get, file_put</li>
</ul>
<p>The following image represents the use of lock files with symbols, to
easily check that they are used properly. The global lock (the red
one) is used to protect file creation and deletion, that is changes to
the filesystem, while the local lock is used for changes within a
specific whiteboard database or folder.</p>
<img alt="images/server_concurrency.png" src="images/server_concurrency.png" />
<p>The existence of different local locks is very important when users
are working on different whiteboards on the same server.</p>
<p>With this model, a file_delete can remain blocked on the local lock if
a file get/put has to finish, but it happens rarely that a whiteboard
is deleted so this is not a problem for performances.</p>
</div>
<div class="section" id="whiteboard-existence-and-automatic-logout">
<h4>Whiteboard existence and automatic logout</h4>
<p>All functions into <tt class="docutils literal"><span class="pre">updates.php</span></tt> which read the whiteboard database
are subject to failure if the whiteboard has been deleted. Usually
when a whiteboard is deleted the first function which fails is the
<tt class="docutils literal"><span class="pre">read</span></tt> function which is waiting in a long polling cycle.</p>
<p>When the <tt class="docutils literal"><span class="pre">read</span></tt> function fails, an explicit error message is sent to
the client functions which handle the XML response, and those
functions force the user to log out.</p>
<p>This is the reason why it is very difficult that another function can
fail for an unexistent whiteboard, because usually users are forced to
log out as soon as the whiteboard is deleted. This is the reason
because error handling is not very important for a missing whiteboard,
for all functions but the <tt class="docutils literal"><span class="pre">read</span></tt> function.</p>
</div>
<div class="section" id="permission-file-access">
<h4>Permission file access</h4>
<p>This file is accessed just through the function <tt class="docutils literal"><span class="pre">check_permissions</span></tt>,
and if the file doesn't exist the function creates on its first
invocation. The concurrent access on this file can in the worst case
create it two times with the same default content, while for the rest
of the application life the file is accessed just for reading.</p>
</div>
</div>
</div>
<div class="section" id="emulating-a-client-push-behavior-with-the-http-technology">
<h2><a class="toc-backref" href="#id27">Emulating a client <em>push</em> behavior with the http technology</a></h2>
<p>When using a pull update technique, there is a trade-off on the
frequency of client update requests. Frequent requests improve the
responsiveness to changes made from other users, but increase the
network load, and the server and client overhead (although the latter
is negligible).</p>
<p>In this application, a behavior similar to a pull-like one is achieved
simply delaying the response send to the client that asked for
updates. If an updates request comes to the server while no new
updates are available, the response is delayed by a configurable
amount of time during which the server process periodically checks the
presence of new updates, until a new one is found or the number of
retries becomes too high. After a given number of retries with no new
updates, the server replies to the client with an empty response.</p>
<p>The cost of this technique is that of a suspended server process for
each client, that periodically wakes up and opens the database for
reading.</p>
<p>Here it is a simplified snippet of code taken from the server side
function 'read', which handles the response to a client update
request. At lines 2 and 4, <tt class="docutils literal"><span class="pre">$server_update_retry</span></tt> and
<tt class="docutils literal"><span class="pre">$server_update_timeout</span></tt> are two parameters configurable into the
file <tt class="docutils literal"><span class="pre">configuration.php</span></tt>.</p>
<pre class="literal-block">
 1    // The time interval between each check
 2    $update_wait = (int)$server_update_timeout/$server_update_retry;
 3    // wait until we find new ids, or until maximum retry number
 4    for ($i = 0; $i &lt; $server_update_retry; $i++) {
 5        // Read the database and retrieve the latest id
 6        $d = file_get($c['wb_file'], 'r');
 7        if ($d['next_upd_id'] &gt; $id)
 8            break;
 9        usleep($update_wait);
10    }
11    // After the cycle, respond with the new lines or an empty response
</pre>
<p>This technique is quite common for ajax applications and it is called
also <strong>long polling</strong>.</p>
</div>
<div class="section" id="global-variables-directly-sent-from-the-server-to-the-client">
<h2><a class="toc-backref" href="#id28">Global variables directly sent from the server to the client</a></h2>
<p>There is an amount of client-side global variables that must be set
by the server side code. These are usually variables depending on the
specific user or on the specific session, so they may change each time
an user makes a new login.</p>
<p>There is a sort of channel, a way of transmission of all these
variables from the (server side) database record for the specific user
to the client side global scope.</p>
<p>the variables are read from the database record into <tt class="docutils literal"><span class="pre">updates.php</span></tt>
by the following function:</p>
<pre class="literal-block">
function get_user_vars($c, ...){
    $user_id = $c['user_id'];
    ...
    $d = file_get($c['wb_file'], 'r');
    ...
    return build_user_vars($user_id, $d['uids'][$user_id]);
}
</pre>
<p>Some variables are directly read from the database, some others must
be built by <tt class="docutils literal"><span class="pre">build_user_vars</span></tt>. The function is called inside
<tt class="docutils literal"><span class="pre">main.php</span></tt>, before sending the application page to the user:</p>
<pre class="literal-block">
app_page_send(get_user_vars($client_id), $o['content']);
</pre>
<p>Inside <tt class="docutils literal"><span class="pre">app_page_send</span></tt> (defined into <tt class="docutils literal"><span class="pre">markup_send.php</span></tt>), the
variables are encoded like input fields into an hidden form:</p>
<pre class="literal-block">
         &lt;!-- Client side session variables read by init() into common.js --&gt;
         &lt;div class=&quot;hidden&quot;&gt;
           &lt;form id=&quot;session_datas&quot;&gt;';
foreach ($client_vars as $name=&gt;$value)
    $content .= '
             &lt;input type=&quot;hidden&quot; name=&quot;'.$name.'&quot; value=&quot;'.$value.'&quot;&gt;';
$content .= '
           &lt;/form&gt;
         &lt;/div&gt;';
</pre>
<p>Finally, during the client-side initialization of the application page
(function <tt class="docutils literal"><span class="pre">onsvgload</span></tt> into <tt class="docutils literal"><span class="pre">application.js</span></tt>), these variables get
read and exposed on the global scope, into the <tt class="docutils literal"><span class="pre">S</span></tt> object (the main
global object together with <tt class="docutils literal"><span class="pre">g</span></tt>):</p>
<pre class="literal-block">
// Get client-side variables from server-side ones embedded into
// document nodes
var server_vars = ['user', 'client_id', 'width', 'height', 'svg_w', 'svg_h',
                   'slides', 'user_id', 'obj_prefix'];
var form = getById('session_datas');
for(v in server_vars)
    S[server_vars[v]] = form[server_vars[v]].value;
</pre>
<p>This channel is useful also to send server-side configuration
variables on the client side; for example, it would be easy to unify
the server side <tt class="docutils literal"><span class="pre">debug</span></tt> configuration variable with the client side
one.</p>
<div class="section" id="role-of-build-user-vars">
<h3><a class="toc-backref" href="#id29">Role of <tt class="docutils literal"><span class="pre">build_user_vars</span></tt></a></h3>
<p>I encapsulated the building of user variables into this function
because sometimes the user variables are needed also on the server
side (when acquiring an image, for example, whe need the svg sizes for
a given user). In these cases, <tt class="docutils literal"><span class="pre">build_user_vars</span></tt> can be called to
process an user data array and obtain the user variables without
further database access.</p>
</div>
</div>
<div class="section" id="global-and-local-measure-units">
<h2><a class="toc-backref" href="#id30">Global and local measure units</a></h2>
<p>At one point of the project, it was decided that all users should see
the same content on the whiteboard, regardless of the actual sizes in
pixes of each own's whiteboard.</p>
<p>To accomplish this, the size and position of each object is expressed,
on the server side, with a &quot;global&quot; measure unit, that gets translated
to pixels just before the objects are drawn on the client. Also the
action of create, move or edit a shape on a client must translate the
local pixel units into global measure units <a class="footnote-reference" href="#svg-relative" id="id6">[5]</a>.</p>
<p>The definition of the global unit is as such: the whiteboard's width
and height measure always 100 global units. So each point within the
canvas has an abscissa and an ordinate that ranges from 0 to 100,
when expressed in global units, and every distance into the whiteboard
can be translated from local to global units and vice-versa with
simple proportions, knowing the sizes of the local canvas.</p>
<p>Currently, the resize is incomplete, since the circles aren't
translated to ellipses, and since the aspect ration of images into the
SVG isn't changed. Also the text size isn't changed.</p>
<p>The translation of measure units is demanded to the client-side object
<tt class="docutils literal"><span class="pre">g['size_adapter']</span></tt> object, which is like a filter for all updates
regarding the whiteboard. The followind diagram shows the relation
between this object and the functions handling the updates:</p>
<img alt="images/size_adapter.png" src="images/size_adapter.png" />
<p>A translation between global units and pixels is performed also on the
server-side, when exporting the whiteboard content to a pdf or image
file.</p>
</div>
<div class="section" id="security-measures">
<h2><a class="toc-backref" href="#id31">Security measures</a></h2>
<p>Some weak security measures were taken, just to discourage users to
try to stole the identity of others, but the taken measures present
several limits so they are intended to provide a reduced level of
security, suitable for an informal use environment, where the trust
isn't a problem, and where the possible damage done by an attacker is
reduced.</p>
<div class="section" id="request-signature">
<h3><a class="toc-backref" href="#id32">Request signature</a></h3>
<p>The main security measure is to not send the plain text form of the
user password with each request, but instead to <em>sign</em> each request
with the user password on the client side, so that the server can use
his stored password to verify the signature.</p>
<p>This is accomplished by the <tt class="docutils literal"><span class="pre">g['signer']</span></tt> object on the client side,
and by the <tt class="docutils literal"><span class="pre">verify_credentials</span></tt> function on the server side. This
kind of signature get done just for those modes which require an
authentication, which are defined into the <tt class="docutils literal"><span class="pre">$known_modes</span></tt>
array. Both the <tt class="docutils literal"><span class="pre">$known_modes</span></tt> array and the use of
<tt class="docutils literal"><span class="pre">verify_credentials</span></tt> function can be found into the <tt class="docutils literal"><span class="pre">main.php</span></tt>
file.</p>
<p>The only moment when the password get transmitted in plain text form
through the http channel is when the user registers himself,
associating that password with his name.</p>
</div>
<div class="section" id="reply-attack">
<h3><a class="toc-backref" href="#id33">Reply attack</a></h3>
<p>This kind of security mechanism is prone to a reply attack, because
the signed part of the request is the same for different requests. To
reduce this problem, there is a continuous exchange, between the
server and the client, of a time-dependent value, which makes requests
not reusable after a given time interval.</p>
<p>This time-dependent value is a timestamp, generated and signed by the
server (function <tt class="docutils literal"><span class="pre">update_salt</span></tt> into <tt class="docutils literal"><span class="pre">updates.php</span></tt>), which becomes
part of the data signed from the client (function <tt class="docutils literal"><span class="pre">get_signature</span></tt>
within the <tt class="docutils literal"><span class="pre">g['signer']</span></tt> object into <tt class="docutils literal"><span class="pre">common.js</span></tt>), and then is
checked by the server for each authenticated request. The
<tt class="docutils literal"><span class="pre">g['signer']</span></tt> object has the responsability of keeping the server
timestamp (also called <em>server salt</em>) updated, using an ajax channel.</p>
<p>The variable ruling the timestamp validity is
<tt class="docutils literal"><span class="pre">$server_timestamp_validity</span></tt> into <tt class="docutils literal"><span class="pre">verify_credentials</span></tt> into
<tt class="docutils literal"><span class="pre">updates.php</span></tt>, the variable ruling the interval used by the client
for updating the timestamp is <tt class="docutils literal"><span class="pre">cycle_timeout</span></tt> into the
<tt class="docutils literal"><span class="pre">g['signer']</span></tt> object into <tt class="docutils literal"><span class="pre">common.js</span></tt>. If this parameters shall
become configuration variables, the client <tt class="docutils literal"><span class="pre">cycle_timeout</span></tt> value
should be sent from the server to the client (see <a class="reference internal" href="#global-variables-directly-sent-from-the-server-to-the-client">Global variables
directly sent from the server to the client</a>).</p>
</div>
</div>
<div class="section" id="timeout-effects">
<h2><a class="toc-backref" href="#id34">Timeout effects</a></h2>
<p>A timeout is a problem that must be handled at both ends of the
communication, the server and the client. Indeed, the natural handling
for a timeout is a retry, and when retries are in play a protocol
problem arises, to avoid message duplication.</p>
<p>Actually, considering the operations handled through asynchronous
(ajax) requests, it can be seen that many of them don't have
server-side effect, so their duplication is not important. These are
the requests sent with modes: <tt class="docutils literal"><span class="pre">read</span></tt> (<tt class="docutils literal"><span class="pre">g['receiver']</span></tt> object),
<tt class="docutils literal"><span class="pre">update_salt</span></tt> (<tt class="docutils literal"><span class="pre">g['signer']</span></tt> object), <tt class="docutils literal"><span class="pre">checkuser</span></tt>
(<tt class="docutils literal"><span class="pre">g['login']</span></tt> object).</p>
<div class="section" id="sender-requests-and-the-send-id">
<h3><a class="toc-backref" href="#id35">Sender requests and the <tt class="docutils literal"><span class="pre">send_id</span></tt></a></h3>
<p>The <strong>only problem</strong> comes with a request sent by the <tt class="docutils literal"><span class="pre">g['sender']</span></tt>
object with the <tt class="docutils literal"><span class="pre">write</span></tt> parameter: this is a request carrying an
<strong>update</strong>, and repeting it is not safe, so the server must detect and
nullify a duplicated request.</p>
<p>To made the update requests detectable, it is necessary to assign an
identifier to each of them. A new unique identifier must be created on
the client side and verified on the server side, so the two sides must
be synchronized from the client side initialization and through all
request attempts.</p>
<p>This application doesn't mantains a (server side) session state, but
just a whiteboard and an user state, so the <em>current update
identifier</em> must be an user variable, sent with the other variables as
seen into <a class="reference internal" href="#global-variables-directly-sent-from-the-server-to-the-client">global variables directly sent from the server to the
client</a>.</p>
<p>The identifier is a variable called <tt class="docutils literal"><span class="pre">send_id</span></tt>. Its value is sent as
a query field with each <tt class="docutils literal"><span class="pre">write</span></tt> request, and incremented separately
by the client and the server in case of success.</p>
</div>
</div>
<div class="section" id="parametric-layout">
<h2><a class="toc-backref" href="#id36">Parametric layout</a></h2>
<p>Just a short mention about the layout configuration variables. Through
all the code, I tried to refer to those variables as much as possible,
but the layout is not fully parametric currently, and it would be
difficult event to simply state what kind of layout feature should be
modified by the administrator and how. However I always try to refer
to global variables (on the server side) and to server variables (on
the client side) in order to have, at least, a good level of internal
coherence when referring to the same values.</p>
</div>
</div>
<div class="section" id="data-structures">
<h1><a class="toc-backref" href="#id37">Data structures</a></h1>
<p>This section is very important for the developer, due to the lack of
incapsulation that can affect some data structures. It is important to
mantain a centralized reference for data structures, to preserve their
coherence while they get accessed by several peripheral functions
both in the client and the server side.</p>
<div class="section" id="stored-data">
<h2><a class="toc-backref" href="#id38">Stored data</a></h2>
<p>Stored data are those which get wrote on the disk by the server side
code, into the files choosen through the configurable variables into
<tt class="docutils literal"><span class="pre">configuration.php</span></tt>.</p>
<p>When the server configuration variable <tt class="docutils literal"><span class="pre">$debug</span></tt> is set to <tt class="docutils literal"><span class="pre">true</span></tt>,
for each file read by the server (function <tt class="docutils literal"><span class="pre">file_get</span></tt>) a readable
copy of the content is written on the disk, with the suffix
&quot;-debug&quot;. This can help in fixing issues and for a better
understanding of data structures.</p>
<p>The stored data reside into the <tt class="docutils literal"><span class="pre">data/</span></tt> folder, even if all position
can be configured. This image shows the default structure of the data
folder (lock files are not shown, see <a class="reference internal" href="#server-side-concurrency">Server side concurrency</a> for
details on locking):</p>
<img alt="images/default_structure_data_folder.png" src="images/default_structure_data_folder.png" />
<p>In the image you can see the folders <tt class="docutils literal"><span class="pre">imported</span></tt> and <tt class="docutils literal"><span class="pre">whiteboards</span></tt>,
which get filled and emptied by the server with the creation and
deletion of new whiteboards. For each whiteboard, a file is created
into <tt class="docutils literal"><span class="pre">private/whiteboards</span></tt>, and a folder into <tt class="docutils literal"><span class="pre">imported</span></tt>.</p>
<p>The files <strong>permissions</strong> and <strong>passwords</strong> are essential for the
application's operation, so if they are missing they get created
automatically and filled by the server side code with default
content. For this reason, the files aren't present into the
application's distribution (see <a class="reference internal" href="#permission-file">Permission file</a> for some
details). Also the <tt class="docutils literal"><span class="pre">log</span></tt> file is created by the first server log
message.</p>
<p>As you can see, the imported images stay into a public folder, while
all other data should stay into a private one (although folder's names
can't actually say which permissions were given to those folders).</p>
<p>Two types of data get stored on the server, which are very different:</p>
<ul class="simple">
<li>textual data, usually an encoded form of complex php arrays</li>
<li>images</li>
</ul>
<p>the textual data are often a serialized form of php variables, except
in the case of the permission table (<tt class="docutils literal"><span class="pre">$permission_file</span></tt>) which has a
precise format in order to be easily used from the administrator.</p>
<p>The images are those imported from a pdf file for a user <em>import</em>
request, or those grabbed by the web after a user <em>image create</em>
action. They are deleted by the server when the user requires the
deletion of the corresponding whiteboard object.</p>
<p>Imported images reside in a folder which is specific for each
whiteboard. The folder is created when there is the need to import the
first image (function <tt class="docutils literal"><span class="pre">acquire_image</span></tt> into <tt class="docutils literal"><span class="pre">updates.php</span></tt>), and
deleted with all its content when the whiteboard is deleted by an user
with the right permissions.</p>
<div class="section" id="whiteboard-database">
<h3><a class="toc-backref" href="#id39">Whiteboard database</a></h3>
<p>The whiteboard database is the most important data repository for the
application. It is specific for each whiteboard, so it can be created
and deleted like whiteboards can be. It contains mainly:</p>
<ul class="simple">
<li>few variables which are global for the whiteboard (mainly counters)</li>
<li>the update database, presented in the initial section <a class="reference internal" href="#main-principle">Main principle</a></li>
<li>user data relative to the whiteboard, like size customizations</li>
</ul>
<p>The database is a serialization of a php array whose structure (with
the correct key names) is the following:</p>
<ul>
<li><p class="first">database</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">next_upd_id</span></tt>: identifier for the next update that will be stored</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">next_usr_id</span></tt>: identifier for the next user that will join this whiteboard</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">delete_count</span></tt>: the number of objects deleted since the last cleanup</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">updates</span></tt> <a class="footnote-reference" href="#ordered" id="id7">[7]</a>: the update database; each update contains the
following fields (those with the star * symbol are added by the
server):</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">update_id</span></tt> *: it is the key of the update in the database array</li>
<li><tt class="docutils literal"><span class="pre">time</span></tt> *: timestamp when the server added the update</li>
<li><tt class="docutils literal"><span class="pre">madeby</span></tt> *: user <em>name</em> (not user id) of the user from whom the
update came</li>
<li><tt class="docutils literal"><span class="pre">page</span></tt></li>
<li><tt class="docutils literal"><span class="pre">objid</span></tt>: see <a class="reference internal" href="#object-id">Object id</a> under <a class="reference internal" href="#joined-arrays">Joined arrays</a></li>
<li><tt class="docutils literal"><span class="pre">action</span></tt></li>
<li><tt class="docutils literal"><span class="pre">parameters</span></tt>: see <a class="reference internal" href="#action-parameters">Action parameters</a> under <a class="reference internal" href="#joined-arrays">Joined arrays</a></li>
</ul>
</blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">uids</span></tt>: the array of user data pertaining a whiteboard, which is
indexed with each user's id</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">username</span></tt>: a string with the name of this user. This is
unique like the user id, because it is the value the user fills
in to identify himself at the login page.</li>
<li><tt class="docutils literal"><span class="pre">session_id</span></tt>: a counter which is incremented each time the
application page is sent to the user. This will be used to
build unique object ids on the client side.</li>
<li><tt class="docutils literal"><span class="pre">client_id</span></tt>: the client identifier, a variable sent by the
client to the server (see <a class="reference internal" href="#the-client-identifier">The client identifier</a> for
details). It is not strictly necessary to store this value, it
could be easily built each time it is needed (function
<tt class="docutils literal"><span class="pre">get_user_variables</span></tt> and function <tt class="docutils literal"><span class="pre">login</span></tt> into
<tt class="docutils literal"><span class="pre">updates.php</span></tt>).</li>
<li><tt class="docutils literal"><span class="pre">slides</span></tt>: the addres that the user has loaded into the iframe
panel</li>
<li><tt class="docutils literal"><span class="pre">send_id</span></tt>: a sequence number for client <tt class="docutils literal"><span class="pre">write</span></tt> requests
(see <a class="reference internal" href="#sender-requests-and-the-send-id">Sender requests and the send_id</a>)</li>
</ul>
<p>The following parameters are the layout parameters which a user
can personalize, and which must be kept server side because they
affect the sizes of the root svg element which can't be modifyed
client side. The parameters are set to default values when a new
user is created (function register into updates.php).</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">width</span></tt>: total width of the whiteboard</li>
<li><tt class="docutils literal"><span class="pre">height</span></tt>: total height of the whiteboard</li>
<li><tt class="docutils literal"><span class="pre">side_w</span></tt>: width of the right side pane containing the chat
and the iframe</li>
</ul>
</blockquote>
</li>
</ul>
</li>
</ul>
<div class="section" id="serialize-and-json-encode">
<h4>serialize and json_encode</h4>
<p>During the development, I switched from the use of <tt class="docutils literal"><span class="pre">serialize</span></tt> to
the use of <tt class="docutils literal"><span class="pre">json_encode</span></tt> to store the php variables on the disk. I
did this because I found that even the simplest arrays were encoded by
<tt class="docutils literal"><span class="pre">serialize</span></tt> including their indexes, like into the example below:</p>
<pre class="literal-block">
'updates' =&gt;
array (
  1 =&gt;
  array (
    '0'=&gt;1,
    '1'=&gt;1287411219,
    '2'=&gt;'fra',
    '3'=&gt;'0',
    '4'=&gt;'1_4_1',
    '5'=&gt;'image',
    '6'=&gt;'...'
  ),
  2 =&gt;
  array (
    '0'=&gt;2,
    '1'=&gt;1287411224,
    '2'=&gt;'fra',
    '3'=&gt;'0',
    '4'=&gt;'1_4_1',
    '5'=&gt;'move',
    '6'=&gt;'-21.4|-14.9',
  ),
  3 =&gt;
  array (...
</pre>
<p>While the string produced by <tt class="docutils literal"><span class="pre">json_encode</span></tt> is more compact (spaces
and newlines added here for readability):</p>
<pre class="literal-block">
&quot;updates&quot;:{
        &quot;1&quot;:[1,1288003041,&quot;fra&quot;,&quot;0&quot;,&quot;1_1_0&quot;,&quot;path&quot;,&quot;...&quot;],
        &quot;2&quot;:[2,1288003041,&quot;fra&quot;,&quot;0&quot;,&quot;1_1_1&quot;,&quot;path&quot;,&quot;...&quot;],
        &quot;3&quot;:[...
</pre>
</div>
</div>
<div class="section" id="permission-file">
<h3><a class="toc-backref" href="#id40">Permission file</a></h3>
<p>This file is necessary for the application to run, because it rules
the behavior of the application when it comes to give to any user the
permission to do fundamental actions, that are creating, accessing or
deleting any whiteboard.</p>
<p>The file is conceived to be manually edited by the application's
administrator, so it is structured as a &quot;delimited separed values&quot;
file, with a single space as delimiter. The form of each row must be
the following:</p>
<pre class="literal-block">
&lt;user&gt; &lt;whiteboard&gt; &lt;permissions&gt;
</pre>
<p>Where <tt class="docutils literal"><span class="pre">&lt;user&gt;</span></tt> and <tt class="docutils literal"><span class="pre">&lt;whiteboard&gt;</span></tt> can be two regexp, and
<tt class="docutils literal"><span class="pre">&lt;permissions&gt;</span></tt> is a string composed by the letters <tt class="docutils literal"><span class="pre">a</span></tt>, <tt class="docutils literal"><span class="pre">c</span></tt>,
<tt class="docutils literal"><span class="pre">d</span></tt>, each one giving, when present, the permission to access, create
or delete, to the given user regexp on the given whiteboard regexp.</p>
<p>This file is missing into the application package, so the
administrator can write one by himself. If he doesn't, the server side
code will create a file with the default rule of allowing everything
to everyone (see function <tt class="docutils literal"><span class="pre">check_permissions</span></tt> into
<tt class="docutils literal"><span class="pre">file_access.php</span></tt>), that is a rule like this:</p>
<pre class="literal-block">
.* .* abc
</pre>
<p>This file is just read by the short function <tt class="docutils literal"><span class="pre">check_permissions</span></tt>
into <tt class="docutils literal"><span class="pre">file_access.php</span></tt>, so check out that function to retrieve
detailed informations, as the use of the library functions <tt class="docutils literal"><span class="pre">fgetcsv</span></tt>
to read the file and <tt class="docutils literal"><span class="pre">ereg</span></tt> to evaluate the regular expression.</p>
</div>
<div class="section" id="password-file">
<h3><a class="toc-backref" href="#id41">Password file</a></h3>
<p>The passwords file is read and written with the same functions used
for the whiteboard databases, in order to store a php variable into
it. The structure of this variable is very simple:</p>
<pre class="literal-block">
array('server_pass' =&gt; 'password_s',
      'user_pass'   =&gt; array('username1' =&gt; 'password_1',
                             'username2' =&gt; 'password_2',
                             'username3' =&gt; 'password_3');
</pre>
<p>The passwords are written when each user registers himself (that is
also the only moment when they go through the http channel in plain
text form).</p>
<p>The <tt class="docutils literal"><span class="pre">server_pass</span></tt> is generated and used by the server to sign the
salt.</p>
</div>
</div>
<div class="section" id="joined-arrays">
<h2><a class="toc-backref" href="#id42">Joined arrays</a></h2>
<p>The whiteboard makes wide use of joined arrays to handle complex data
structures. This means that an array is translated into a string (with
one-character separators between his elements) at one side of the
transmission, and this string can be split again at the other end,
where the details of the data structure must be read or changed.</p>
<p>For example, this diagram shows how the parameters and other data
pertaining a new action get sent to the server, packed with the use
of <tt class="docutils literal"><span class="pre">|</span></tt>, <tt class="docutils literal"><span class="pre">:</span></tt>, <tt class="docutils literal"><span class="pre">;</span></tt> separators.</p>
<img alt="images/sending_update_separators.png" src="images/sending_update_separators.png" />
<p>Data are encoded on different levels to allow the expansion of certain
fields; for example, the object id structure could (and did) change
over time, and the update parameters change with the different action
type.</p>
<p>The text inserted by the user (for example, into a <tt class="docutils literal"><span class="pre">chat</span></tt> action
update) is escaped (using <em>urlencoding</em>) to prevent its content from
interfering with the separators.</p>
<div class="section" id="object-id">
<h3><a class="toc-backref" href="#id43">Object id</a></h3>
<p>Each object Id must be unique value into a whiteboard database; it has
the following structure:</p>
<pre class="literal-block">
&lt;user id&gt; _ &lt;session id&gt; _ &lt;object counter&gt;
</pre>
<p>like as &quot;3_35_12&quot;</p>
<dl class="docutils">
<dt>user id</dt>
<dd>The user id (they start from 1, the value 0 can be used by the
server if it needs to build objects not associating them to any
user).</dd>
<dt>session id</dt>
<dd>The session id is incremented each time a user receives the
application page, and transmitted to the client where it remains
as a global variable. This is the main value that grants the
unicity of the object ids because it is different for each
initialization of the javascript environment (for a given user on
a given whiteboard).</dd>
<dt>object counter</dt>
<dd>It starts from zero when the javascript is initialized, that is
with each new session id.</dd>
</dl>
<div class="section" id="server-object-id">
<h4>Server object id</h4>
<p>The server doesn't have an user or session id, however there is a case
where it has to build objects with an unique object id. This happens
into the function <tt class="docutils literal"><span class="pre">import</span></tt> (file <tt class="docutils literal"><span class="pre">updates.php</span></tt>), where several pdf
pages are turned into images and inserted into the whiteboard.</p>
<p>The object id used this time has the form:</p>
<pre class="literal-block">
&lt;user id&gt; _imported_ &lt;page counter&gt;
</pre>
<p>And it is unique anyway, because when the import operation is
performed, each page that will be fill with a pdf page is cleared
before, so two objects named <tt class="docutils literal"><span class="pre">_imported_</span></tt> with the same page counter
can't exist (the <tt class="docutils literal"><span class="pre">&lt;user</span> <span class="pre">id&gt;</span></tt> is thus not strictly necessary).</p>
</div>
</div>
<div class="section" id="action-parameters">
<h3><a class="toc-backref" href="#id44">Action parameters</a></h3>
<p>The handling of action parameters is quite unconfortable for the
developer: here I will describe the current state of the code, while
in the next session I will discuss drawbacks and alternatives to the
use of joined arrays to encode this data.</p>
<p>The parameters can change depending on the type of action, and must be
accessed in a coherent way through all the code. The actual order of
parameters for an action is decided when the update string is created,
that is on the client side, in all the places before the
<tt class="docutils literal"><span class="pre">sender_add</span></tt> function is called.</p>
<div class="section" id="shape-action">
<h4>Shape action</h4>
<p>Each shape defines its list of parameters, wich it will use to read
updates to the server, to send them, and sometimes to clone an
existent shape for editing. Here is a snippet of a shape defining its
attributes (taken from the file <tt class="docutils literal"><span class="pre">shapes.js</span></tt>):</p>
<pre class="literal-block">
function line(){
    var att = ['opacity','stroke-width','x1','y1','x2','y2'];
</pre>
<p>These definitions must be taken as the reference for the meaning of
parameters for shape actions (line, path, rect, circle, polygon,
polyline, etcetera), but remember that the actual index must be
incremented by two, because each shape has two default attributes
defined into the parent class <tt class="docutils literal"><span class="pre">shape</span></tt>, as can be seen into this
snippet taken by that class:</p>
<pre class="literal-block">
// The colors are common attributes between all shapes
var colors = ['stroke', 'fill'];
object.att = colors.concat(att);
</pre>
<p>For example, the final positions of parameters in a <tt class="docutils literal"><span class="pre">line</span></tt> action
will be:</p>
<pre class="literal-block">
stroke | fill | opacity | stroke-width | x1 | y1 | x2 | y2
0        1      2         3              4    5    6    7
</pre>
</div>
<div class="section" id="other-actions">
<h4>Other actions</h4>
<p>I will summarize in a table the parameters for all actions which are
not shapes (line, circle, rect, path, etcetera are excluded). For each
action, I include the file from where the corresponding <tt class="docutils literal"><span class="pre">sender_add</span></tt>
function is called (this can be easy wiewed using <tt class="docutils literal"><span class="pre">grep</span> <span class="pre">sender_add</span>
<span class="pre">*.js</span></tt>). Actions <tt class="docutils literal"><span class="pre">clear</span></tt> and <tt class="docutils literal"><span class="pre">delete</span></tt> don't have parameters.</p>
<table border="1" class="docutils">
<caption>Parameters for not-shape actions</caption>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Action</th>
<th class="head">Parameters</th>
<th class="head">File</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>move</td>
<td>translation_x | translation_y</td>
<td>whiteboard.js</td>
</tr>
<tr><td>chat</td>
<td>escaped_text</td>
<td>chat.js</td>
</tr>
<tr><td>slides</td>
<td>escaped_url</td>
<td>menu.js</td>
</tr>
<tr><td>clear</td>
<td><em>clear</em></td>
<td>whiteboard.js</td>
</tr>
<tr><td>delete</td>
<td><em>delete</em></td>
<td>whiteboard.js</td>
</tr>
</tbody>
</table>
<p>You can see that the files roughly correspond to the position of the
user interface element that the user activates to perform a given
action.</p>
<p>For actions without parameters, usually a copy of the action type (for
example <tt class="docutils literal"><span class="pre">delete</span></tt> for the <em>delete</em> action) is used as parameter, to
avoid problems found while parsing empty XML fields with Internet
Explorer (there is a comment on this into the main <tt class="docutils literal"><span class="pre">for</span></tt> cycle into
<tt class="docutils literal"><span class="pre">receiver_handler</span></tt> into application.js). The copy of the action type
is filled automatically by <tt class="docutils literal"><span class="pre">sender_add</span></tt> when the <tt class="docutils literal"><span class="pre">parameter</span></tt>
argument is missing or it is an empty array.</p>
</div>
</div>
<div class="section" id="drawbacks-and-alternatives-to-the-use-of-joined-arrays">
<h3><a class="toc-backref" href="#id45">Drawbacks and alternatives to the use of joined arrays</a></h3>
<p>The use of joined arrays has several advantages, like easiness of
implementation and an efficient use of storage space, but it also
presents severe drawbacks when considering readability and
maintainability of the code, since the developer has to use positional
parameters in a coherent way each time he tries to parse the format.</p>
<div class="section" id="joined-arrays-for-the-update-structure">
<h4>Joined arrays for the update structure</h4>
<p>The handling of this joined array has been eased introducing a
variable which associates labels to positional indexes. This is the
global variable <tt class="docutils literal"><span class="pre">$u_keys</span></tt>, defined at the top of <tt class="docutils literal"><span class="pre">updates.php</span></tt> and
used just within this file. This variable is used to grant the
coherence of functions which access the update on the server side (all
these functions stay into <tt class="docutils literal"><span class="pre">updates.php</span></tt>), while the database remains
free of redundant labels; however, the syntax can sometimes turn messy
like in this example (taken from function <tt class="docutils literal"><span class="pre">cleanup</span></tt>):</p>
<pre class="literal-block">
...
// Second pass: remove cleared or deleted objects
foreach ($updates as $upd_id =&gt; $update){
    $page  = $update[$u_keys['page']];
    $objid = $update[$u_keys['objid']];
    $remove = false;
    if (isset($clear_collection[$page])){
        if ($clear_collection[$page] &gt; $upd_id)
            $remove = true;
    }
    else if (isset($delete_collection[$objid])){
        // Check if we have to remove the image from the filesystem
        if($update[$u_keys['action']] == 'image')
            delete_image($update[$u_keys['parameters']], $wb);
        $remove = true;
    }
    if ($remove)
        unset($updates[$upd_id]);
}
...
</pre>
<p>There is another coupling between the client and the server related to
the order of update fields: it occurs when an update is first sent
from the client to the server. It is the programmer, this time, that
must ensure the coherence between the client side function
<tt class="docutils literal"><span class="pre">sender_add</span></tt> into <tt class="docutils literal"><span class="pre">application.js</span></tt> and the server side function
<tt class="docutils literal"><span class="pre">write</span></tt> into <tt class="docutils literal"><span class="pre">updates.php</span></tt>. These functions are at the two end
points of the transmission of a new update. This coupling could be
eliminated using JSON as data format for update upload.</p>
<p>With regard to the last transmission of the update from the server
back to the client, XML is used due to the ajax technology, so some
textual labels must be given into <tt class="docutils literal"><span class="pre">read</span></tt>, which will be transmitted
to the client together with the data in XML form; so there are no
problems with the positional parameters in this case. The encoding and
parsing for update download could probably be simplified using JSON as
data format.</p>
</div>
<div class="section" id="joined-arrays-for-the-action-parameters">
<h4>Joined arrays for the action parameters</h4>
<p>The use of positional parameters is quite a problem with the action
parameters handling, because action parameters get accessed by
different parts of both server and client side code, and the developer
has to check manually if each index is the right one.</p>
<p>The parts of the code that are depending on the parameter positions
range from the shape (and chat message) creation functions on the
client side, to the server side functions which export the whiteboard
contents in different formats, to other server side functions (for
example, the acquisition on the server of a newly inserted image).</p>
<p>The alternative would be to have textual labels associated to each
field, this would be much readable and much maintainable, but this
would come at a cost: how to store these labels when the actions get
written into the database?</p>
<p>It is clear that all actions of a given type stored into the database
should have the same format, so there's no reason to repeat the
format; a centralized reference should exist to hold the appropriate
labels.</p>
<p>This <em>label reference</em> would be an array with the form:</p>
<pre class="literal-block">
line:    'stroke', 'fill', 'opacity', 'stroke-width', ...
polygon: 'stroke', 'fill', 'fill-opacity', ...
</pre>
<p>This label reference should be either transmitted between the client
and the server, or defined two times, once on the client and once on
the server side. I think the latter is the best solution, but the two
structures should be syntactically as similar as possible, to be
easily compared and updated by the developer in case of change</p>
<p>As already seen, on the client side, each shape defines its parameters
(in the file <tt class="docutils literal"><span class="pre">shapes.js</span></tt>). This comes from the object oriented
paradigm, in an effort to make each shape opaque and independent from
the rest of the code.</p>
<p>Wheter is better or not to define shape parameters within each shape,
I think it is a subjective matter; however, a centralized <em>label
reference</em> could be added to the server side, and this would probably
be a maintainability improvement.</p>
<p>Until now I have done without a label reference, but I find that the
necessity could come in the future to use textual labels instead of
numerical parameters in the server side, that's why I included this
short analysis into the documentation to explain how to add it.</p>
</div>
</div>
</div>
</div>
<div class="section" id="specific-solutions-and-workarounds">
<h1><a class="toc-backref" href="#id46">Specific solutions and workarounds</a></h1>
<p>In this section I collect several solutions that don't came from the
project of the application, but just from the efforts of implementing
such project. If an issue is spotted and fixed and his solution is
worth writing, or if a workaround is used to avoid a specific problem,
this is the place where to write it.</p>
<div class="section" id="use-of-svgweb">
<h2><a class="toc-backref" href="#id47">Use of svgweb</a></h2>
<p>These are some techniques used into the client side (whiteboard.js),
to allow svgweb to do is work, translating svg functions and objects
to flash ones. Some of these recommendations can also be found on
svgweb official documentation.</p>
<div class="section" id="generic-notes">
<h3><a class="toc-backref" href="#id48">Generic notes</a></h3>
<p>The variable svgns is provided by the library, containing the svg
namespace.</p>
<p>On the &quot;svg&quot; node, width and height must be specified as svg
attributes, not into the svg style attribute.</p>
<p>Dom method &quot;getElementsByTagname&quot; must be replaced with
&quot;getElementsByTagNameNS(g_svgNS, &quot; and &quot;createElement(&quot; with
&quot;createElementNS(g_svgNS, &quot;</p>
<p>Instead of using '.setAttribute' for event listening, and instead of
using html &quot;handler&quot; attribute, use '.addEventListener' for event
listening.</p>
<p>Svgweb requires a boolean in svg createTextNode invocation (a 'true'
as last argument), but this boolean must be omitted if the script is
writing a regular html text node outside the svg.</p>
<p>Svgweb (&quot;gelatinous cube&quot; version, at least) <strong>doesn't support the
&quot;stopPropagation&quot; method</strong>.</p>
<p>To update the text, element.textContent=&quot;new text&quot; doesn't works; it
is necessary to create a new text node with document.createTextNode,
to delete the previous content with element.removeChild, and to append
the new node with element.appendChild.</p>
<p>Text nodes don't inherit event listeners from the &quot;svg&quot; root node, so
we need to add the handlers to a text node when it is created into
'createGroup'. Doing this way however svgweb forwards the 'mousedown'
event to the text node but also to the &quot;svg&quot; node behind, so I added a
check in &quot;handleMouseDown&quot; that nullifies the second call made by the
&quot;svg&quot; node (this can be related to issue 497 that was fixed into the
latest svgweb release, owlefant, so I'm not sure this problem still
stands).</p>
</div>
<div class="section" id="image-and-anchor-support">
<h3><a class="toc-backref" href="#id49">Image and anchor support</a></h3>
<p>Google chrome shows images only outside a text element, and shows
anchors ('a' tags) only inside a text element but not into a tspan
element. This is the reason why there are tree different buttons:
text, link, image, which correspond to a different structure of the
included SVG elements.</p>
<p>The following list is a set of reasons why links have been implemented
like text nodes, with an hidden empty &lt;tspan&gt; inside to identify them,
and they are opened with javascript window.open()</p>
<ul class="simple">
<li>Anchors can't be correctly moved with flash: when trying to move
them the browser navigates them, so it must be avoided their default
handler (but preventDefault at the beginning of handleMouseDown
seems not to be enough, and stopPropagation is not supported by
svgweb).</li>
<li>Anchors appear black with flash renderer (it doesn't honor style
attribute).</li>
<li>With the firefox native renderer, links get opened in a new window,
while with flash they get opened into the same window</li>
</ul>
<p>Image attributes are set together with the setting the xlink
attribute. While I was trying to reorganize the code I kept these
assignments always near, because it seemed to be the only way to make
flash actually show the images. Maybe with the new versions of svgweb
this won't be a problem, but I write this remainder to help in case of
weird problems.</p>
</div>
<div class="section" id="resize-the-svg-root-node">
<h3><a class="toc-backref" href="#id50">Resize the SVG root node</a></h3>
<p>Currently, all user interfaces which resize the SVG canvas require a
refresh of the whole page: this came from the impossibility to
dinamically resize the SVG root element (the <tt class="docutils literal"><span class="pre">&lt;svg&gt;</span></tt> tag), and I
will summarize briefly the attempts made in this direction.</p>
<p>Dynamically change the sizes of the svg root works fine with
firefox/native, but doesn't works with the flash renderer, as it
confirmed also by the issue 427 (see the svgweb issues), at list at
the date of November the 3dh, 2010.</p>
<p>I tried a different way, deleting and rebuilding the svg root node,
but there were errors with sizes (the height was always wrong) and
some contents of the root node were not showed properly. Svgweb
doesn't even allowed to copy the content of the root node on a
temporary variable to append them to a new root node, and so a
<tt class="docutils literal"><span class="pre">refresh</span></tt> request to the server was needed in any case.</p>
<p>From the test made I considered the library support for this kind of
features as unstable, and to speed up the development I decided to use
the simplest method, refreshing the whole page with a new request to
the server. This came also from the consideration that the resize
action is quite infrequent.</p>
</div>
</div>
<div class="section" id="coordinates-within-the-svg-canvas">
<h2><a class="toc-backref" href="#id51">Coordinates within the svg canvas</a></h2>
<p>This section mainly describes the kind of work done by the function
<tt class="docutils literal"><span class="pre">skew</span></tt> defined into <tt class="docutils literal"><span class="pre">whiteboard.js</span></tt>, to adapt coordinates into the
svg environment. Many of the outcomings written here derived from
direct testing.</p>
<p>Types of coordinates on which to apply an offset:</p>
<ul class="simple">
<li>coordinates from mouse events (target.clientX and target.clientY)</li>
<li>coordinates from nodes position (target.getAttribute)</li>
</ul>
<p>Browser to consider when applying offsets:</p>
<ul class="simple">
<li>firefox/native</li>
<li>chrome/native</li>
<li>flash renderer (mainly on explorer)</li>
</ul>
<p>Effects that modify the position:</p>
<ul class="simple">
<li>the origin of the svg root node</li>
<li>the scrolling state of the page</li>
</ul>
<p>Operations involved:</p>
<ul>
<li><p class="first">object creation (pure mouse coordinate)</p>
</li>
<li><dl class="first docutils">
<dt>object moving (coordinates from position plus difference between</dt>
<dd><p class="first last">mouse coordinates)</p>
</dd>
</dl>
</li>
<li><p class="first">object editing: edited point (pure mouse coordinate)</p>
</li>
<li><p class="first">object editing: other points (coordinates from original nodes positions)</p>
</li>
</ul>
<div class="section" id="browser-behavior-for-svg-offset">
<h3><a class="toc-backref" href="#id52">Browser behavior for svg offset</a></h3>
<dl class="docutils">
<dt>Firefox (native renderer) (3.5.9):</dt>
<dd>Mouse coordinates (retrieved with target.clientX and target.clientY)
are absolute, so we must subtract the position of the svg root,
before assigning those values to attributes of svg nodes. Also other
target.getAttribute (used into init_start) values are absolute.</dd>
<dt>Chrome (native):</dt>
<dd>Mouse coordinates (target.clientX and clientY) are absolute like in
firefox/native, but nodes coordinates (target.getAttribute) are
relative to the svg root and shouldn't be changed. For this reasons,
the function &quot;skew&quot; needs to know if it is adapting a node
coordinate or a pointer coordinate (boolean parameter &quot;pointer&quot;).</dd>
<dt>Flash renderer (tested on firefox):</dt>
<dd>Mouse coordinates (target.clientX) and target.getAttribute are
relative to the svg root, so no further change has to be made.</dd>
</dl>
</div>
<div class="section" id="browser-behavior-for-scroll-state">
<h3><a class="toc-backref" href="#id53">Browser behavior for scroll state</a></h3>
<dl class="docutils">
<dt>Explorer(6)/flash:</dt>
<dd>Page scroll state is written into document.body.scrollLeft or
.scrollTop. This must be applied to every type of coordinates.</dd>
<dt>Firefox/native:</dt>
<dd>Page scroll state is written into window.pageXOffset or
.pageYOffset. This must be applied to every type of coordinates.</dd>
<dt>Chrome/native:</dt>
<dd>Just apply scroll skew to pointer coordinates</dd>
<dt>Firefox/flash:</dt>
<dd>Doesn't need any skew due to the scrolling state</dd>
</dl>
</div>
</div>
</div>
<div class="section" id="testing-environment-and-methods">
<h1><a class="toc-backref" href="#id54">Testing environment and methods</a></h1>
<div class="section" id="browsers">
<h2><a class="toc-backref" href="#id55">Browsers</a></h2>
<p>The test is quite a problem in a project like this, with several kind
of execution environments. The amount of possible execution conditions
is made up by the number of different browsers, but also by the
renderer in use (about two choiches for each browser, the native
renderer and the flash one), and by the different versions of the
flash renderer.</p>
<p>The used method has been to choose a main browser for initial tests,
and then try other browsers with a lower frequence. The browser used
mainly was firefox (3.5) with its native renderer, due to the advantage
provided by the &quot;firebug&quot; plugin (but also google Chrome offers some
developement tools with the same functionalities).</p>
<p>The second browser for test frequency has been Internet Explorer with
the flash renderer. While firefox has quite a stable support to web
standards through its versions, the support provided by Internet
Explorer can change strongly between different versions (many features
can be missing on older versions), so I used an old version (6) in the
purpose of having good code portability.</p>
<p>The third browser was google chrome, with its native renderer. It
behaved mostly like firefox, but the renderer showed some differences
in the handling of svg (pointer coordinates inside the svg canvas,
syntax for polygons/polylines).</p>
<p>These browsers have been used for the tests during the developement,
while I left Opera, Safari, and Explorer 7 and 8 just for a final
test.</p>
</div>
<div class="section" id="debugging-javascript-in-explorer">
<h2><a class="toc-backref" href="#id56">Debugging Javascript in Explorer</a></h2>
<p>The debug difficulties with Explorer often imposed to proceed by
little steps. Javascript errors are showed generically in Explorer,
with a line number that doesn't corresponds to any file (and the
javascript file from which the error comes is not showed).</p>
<p>Since the adoption of the &quot;microsoft script debugger&quot;, the spot of
javascript errors on Explorer has speeded up a lot, but with complex
object structures (and function literals), the debugger can still lose
its usefulness, becoming unable to locate and show the correct error
line. A very cautious approach to the developement of new client side
functions must therefore still be used.</p>
<p>Given that many javascript errors occurred only on explorer (for the
implementation differences, and because this is the environment where
svgweb comes in play), the debug process for such errors became
occasionally very slow and imposed a tight test cycle when developing
new client side features.</p>
<p>A bigger problem comes with the use of the flash renderer with svgweb,
when a behavior is different from that of the native
renderer. Usually, the first step I did when I found problems was to
set the <tt class="docutils literal"><span class="pre">svg.render.forceflash</span></tt> flag to <tt class="docutils literal"><span class="pre">true</span></tt>, to use the flash
renderer also with firefox (this flag is set through a <tt class="docutils literal"><span class="pre">meta</span></tt>
included before the <tt class="docutils literal"><span class="pre">svg.js</span></tt> script, see the function
<tt class="docutils literal"><span class="pre">common_frame</span></tt> into <tt class="docutils literal"><span class="pre">markup_send.php</span></tt>).</p>
<p>Using firefox, even if the actionscript objects are not accessible, it
is possible to use the methods provided by svgweb through the
javascript console, and to follow the javascript execution flow (and
variable changes) in details. The flash renderer run under firefox
behaved <em>almost</em> always like the one run under explorer.</p>
</div>
<div class="section" id="hardware">
<h2><a class="toc-backref" href="#id57">Hardware</a></h2>
<p>The machine upon which all test have been made has the following
characteristics:</p>
<ul class="simple">
<li>processor: Intel Pentium M 1.70 Ghz</li>
<li>memory: 1 GB</li>
</ul>
<p>Which where (obviously) widely sufficient to run the client side code,
even with several open browsers or with explorer running into a
virtual machine.</p>
<div class="section" id="performance-problems">
<h3><a class="toc-backref" href="#id58">Performance problems</a></h3>
<p>One performance problem concerned explorer, inside the virtual
machine, that randomly showed an excessive slowness while showing the
page served by apache on localhost; in this cases, a restart of
explorer fixed the problem.</p>
<p>The server reaches performance limits when handling with graphic
functions (import and export), that indeed work in an asynchronous
manner with respect to user activity on the whiteboard. Especially,
the import of a long (many pages) pdf file into the whiteboard may
take some time and requires full processing power and a substantial
amount of memory (200MB of memory needed to convert a 715KB pdf file
to 27 jpeg images whose cumulating size was 1.7MB).</p>
</div>
</div>
</div>
<div class="section" id="directions-for-further-development">
<h1><a class="toc-backref" href="#id59">Directions for further development</a></h1>
<div class="section" id="prepare-for-html5">
<h2><a class="toc-backref" href="#id60">Prepare for HTML5</a></h2>
<p>In an application like this, that makes a wide use of the front-end
web technologies, an innovation like HTML5 can't be ignored and
instead must be looked as an important opportunity to improve the
quality of the application. A deeper analysis is required, but I can
list here a short set of HTML5 features which can impact on this
application.</p>
<ul class="simple">
<li>the local storage can allow to eliminate the <tt class="docutils literal"><span class="pre">window.name</span></tt> hack
for passing state through different pages</li>
<li>the availability of an offline cache could allow users to make their
drawings while disconnected from the server, and keep them safely
until the moment for sharing it comes <a class="footnote-reference" href="#cache" id="id8">[8]</a></li>
<li>the form validation would be eased</li>
</ul>
<p>But the feature that could completely change the application
architecture is the incoming of <strong>HTML5 websockets</strong>. These would at
least eliminate the trick used for <a class="reference internal" href="#emulating-a-client-push-behavior-with-the-http-technology">Emulating a client push behavior
with the http technology</a>, but their real potential is the
possibility of a <em>peer to peer</em> communication model between the
clients, with the server acting as a coordinator.</p>
<p>Even if this possibility is exciting and may lead to a true revolution
for many web applications, websockets are currently supported just by
the Safari and Chrome web browsers, and are still under strong
development. Even their bare
<a class="reference external" href="http://dev.w3.org/html5/websockets/">specification</a> is still a
draft.</p>
<div class="section" id="the-canvas-element">
<h3><a class="toc-backref" href="#id61">The canvas element</a></h3>
<p>A mention must be done to the <tt class="docutils literal"><span class="pre">&lt;canvas&gt;</span></tt> element which is going to
be widely supported by the browsers which will support HTML5. The fact
that the application is based upon SVG can look like a wrong choice
from this point of view, but please consider that also SVG will be
supported by the same browsers, so it's not so easy to decide which
technology is better. Several articles on the web debate about the
differences between the two methods, and I think that here is better
to speak about the application structure and how much is it binded to
the SVG standard.</p>
<p>The two files that handle the application drawing functions are
<tt class="docutils literal"><span class="pre">whiteboard.js</span></tt> and <tt class="docutils literal"><span class="pre">shapes.js</span></tt>. The first is influenced by the
SVG standard only for the application of move actions and the use of
SVG groups to handle the objects on the whiteboard.</p>
<p>The second file, <tt class="docutils literal"><span class="pre">shapes.js</span></tt>, is tightly binded to the SVG standard,
given that many operations automatically copy the attributes from the
<em>update</em> array to an SVG element, and vice-versa. To change the
structure of <em>update</em> strings is possible and it will have
consequences, on the server side, mainly on the export functions.</p>
<p>These considerations could be valid if we wanted to switch from SVG to
another vectorial format, but <strong>the main problem</strong> is that <strong>vector
graphics</strong> is the obvious choice for having elements that user <strong>can
change</strong> over time. It looks to me that the <tt class="docutils literal"><span class="pre">&lt;canvas&gt;</span></tt> element is
thought for drawing and overlay the space with consecutive drawing
actions, but not for the interaction or manipulation of a shared
content. However my knowledge of <tt class="docutils literal"><span class="pre">&lt;canvas&gt;</span></tt> use is rather limited,
and considering that its use and support may evolve with time, this is
an alternative to keep in mind.</p>
</div>
</div>
<div class="section" id="administration-panel">
<h2><a class="toc-backref" href="#id62">Administration panel</a></h2>
<p>Until now, some complex functions (add users, add and delete
whiteboards) have been embedded into the present controls, and some
others (define user permissions) have been moved to a text file to be
manually edited, but an administration panel will be surely needed to
allow a better management of the application.</p>
<p>For example, a function which is currently missing is an easy way to
reset the password of a specific user. The passwords are encoded in
JSON format, and using <tt class="docutils literal"><span class="pre">base64_encode</span></tt> so it's not possible to edit
them by hand.</p>
<p>The current structure of the application uses very few pages so it is
not straightforward to add a new one, however I write here some steps
to follow in order to add this functionality:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">passwords</span></tt> or <tt class="docutils literal"><span class="pre">configuration.php</span></tt> should hold the superuser
name</p>
</li>
<li><p class="first">The <tt class="docutils literal"><span class="pre">checkuser</span></tt> server-side function should return a third value
(other than <tt class="docutils literal"><span class="pre">used</span></tt> and <tt class="docutils literal"><span class="pre">notused</span></tt>), <tt class="docutils literal"><span class="pre">superuser</span></tt>.</p>
</li>
<li><p class="first">The login page should show a different button to access to the panel</p>
</li>
<li><p class="first">The contents of the panel should be added, that means:</p>
<ul class="simple">
<li>new modes inside main.php</li>
<li>a new <tt class="docutils literal"><span class="pre">markup_send</span></tt> page</li>
<li>a new javascript file</li>
</ul>
<p>Otherwise the controls for operations limited to the administrator
could appear directly into the login page, but this isn't a coherent
design of the login page.</p>
</li>
</ul>
<p>Make sure to check again the superuser identity also on the server
side.</p>
</div>
<div class="section" id="execution-of-the-whiteboard-as-a-cgi">
<h2><a class="toc-backref" href="#id63">Execution of the whiteboard as a CGI</a></h2>
<p>Initially, the whiteboard was conceived with the idea to execute it
also like a CGI, if needed.</p>
<p>The main solution on this purpose was to parse the query string in two
ways, introducing a function that retrieved the query fields either
from the $_REQUEST php global variable, or from the $_ENV global
variable.</p>
<p>The capability of being executed as a CGI was considered less
important later, and the initial query string parsing was removed from
the code.</p>
</div>
</div>
<div class="section" id="web-resources">
<h1><a class="toc-backref" href="#id64">Web resources</a></h1>
<dl class="docutils">
<dt><a class="reference external" href="http://help.dottoro.com/index.php">dottoro web reference</a></dt>
<dd><p class="first">Contains informations about the support of each browser for each
aspect of css, html, and javascript languages. It is very useful
to avoid spending a lot of time for debug. Unfortunately, it
doesn't covers SVG.</p>
<p class="last">Be warned that, although this reference can be very useful the
most of the times, some attribute may still be missing (for
example I didn't found the innerHTML property as belonging to an
iframe object).</p>
</dd>
<dt><a class="reference external" href="http://code.google.com/p/svgweb/issues/">svgweb issue page</a></dt>
<dd>Together with the svgweb mailing list, this is the first place to
search for parts of the SVG standard which are not fully supported
by the library</dd>
</dl>
</div>
<div class="section" id="notes">
<h1><a class="toc-backref" href="#id65">Notes</a></h1>
<table class="docutils footnote" frame="void" id="client-rewrite" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>While a complete rewriting of the client code
would probably be convenient, there wasn't a strict need to
perform it, and I was unable to evaluate the benefits of such
an expensive work. So I decided to use the object oriented
paradigm for the newly developed parts, and to convert only the
more complicated and important parts of the existent code, that
means the core whiteboard logic (resulting into the shape
object) and the ajax channel management (resulting into the
channel object).</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="database-double-access" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>The definition of these two steps seems
quite logical and clean, but it presents a performance
weakness: when the login page or the application page is sent
into the <em>markup send</em> step, another database access must be
performed. This comes because the login page requires a new
salt, and the application page requires data which must be
specific for each user; the problem is that the database access
was likely already made during the <em>update</em> step, by a function
that doesn't cares about the kind of page that will be sent as
output. The <em>update</em> functions could be changed in order to
retrieve directly the data also for the output, but I think
that the problem is negligible currently, because the login and
application pages get sent quite seldom to the user, comparing
with other server modes.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="concurrency" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td>Note that the concurrency hasn't been tested
adequately due to the technical difficulties implied into this
kind of tests. The current solution is based on <strong>flock</strong>, but
the php manual page for <a class="reference external" href="http://www.php.net/manual/en/function.flock.php">flock</a> tells about
several limitations, of which the biggest is with multithreaded
server API. However, if flock will result unadeguate to grant
an exclusive lock on the desired files, it will be sufficient
to change the method used by the functions into
<tt class="docutils literal"><span class="pre">file_access.php</span></tt>. The overall architecture will remain
valid.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="fread-problems" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[4]</a></td><td>Into the function <tt class="docutils literal"><span class="pre">file_get</span></tt> into
<tt class="docutils literal"><span class="pre">file_access.php</span></tt> I use file_get_contents because I had a
problem with fread.  It turned out that filesize($file) wasn't
giving a good value, so junk bytes were read and the parser of
'unserialize' showed errors while reading again the file. The
errors occurred just when the file got opened with the 'r+'
mode, while with the 'r' mode no errors were made on
unserializing.  The problem has been avoided using function
file_get_contents instead of fread.  Maybe the problem was
caused by a wrong use of ftruncate and rewind into
database_put, and is fixed now because file_get_contents does
some kind of parsing. ftruncate fills the file with NULL ASCII
bytes until it reaches the given length, I give length zero,
anyway. All these problems appeared while I was using
<tt class="docutils literal"><span class="pre">serialize</span></tt> to store the data; actually, I use
<tt class="docutils literal"><span class="pre">json_encode</span></tt> instead, because it uses a format which is more
compact.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="svg-relative" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[5]</a></td><td>Another possibility would be to use SVG relative
(percentual) measure units, but this isn't supported for paths
(maybe there is a workaround manipulating the viewport), and
the overall support of svgweb for this feature must be tested
(at the 22 october 2010 there is just the issue 512 related to
the use of percent units). Even using the percentual units, two
conversions should be done for the mouse input and when
exporting the whiteboard content.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="almost" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[6]</a></td><td>How much does <em>almost</em> means depends from the ratio
between the <tt class="docutils literal"><span class="pre">cycle_timeout</span></tt> value defined into the
<tt class="docutils literal"><span class="pre">g['receiver']</span></tt> object and the overall cycle time, including
the <tt class="docutils literal"><span class="pre">server_update_timeout</span></tt> defined into
<tt class="docutils literal"><span class="pre">configuration.php</span></tt>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ordered" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td>Currently, the assumption is made that updates are
ordered. This must be considered if a real database is going to
be used in place of the current file. For example into the
server side <tt class="docutils literal"><span class="pre">import</span></tt> function (file <tt class="docutils literal"><span class="pre">updates.php</span></tt>), a page
is cleared (<tt class="docutils literal"><span class="pre">clear</span></tt> update) before a new image (<tt class="docutils literal"><span class="pre">image</span></tt>
update) is inserted in the page. Inverting the order of these
two updates will lead to a result which is completely wrong.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="cache" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[8]</a></td><td>Actually it should be quite easy to implement. The objects
which implement a channel into the application page
(<tt class="docutils literal"><span class="pre">g['receiver']</span></tt>, <tt class="docutils literal"><span class="pre">g['sender']</span></tt> and <tt class="docutils literal"><span class="pre">g['signer']</span></tt>) should
handle the error condition of an unavailable server asking to
the user if he wants to work in <em>offline mode</em>. With a clear
signalation of this condition to the user, It could freely draw
and his updates would be stored into the <em>sender buffer</em>. The
application should remember its state, and when the client asks
to look for the server again, the <tt class="docutils literal"><span class="pre">g['signer']</span></tt> object should
be the first to operate, asking for an updated server salt.</td></tr>
</tbody>
</table>
</div>
</div>
<div class="footer">
<hr class="footer" />
Generated on: 2010-12-02.

</div>
</body>
</html>
